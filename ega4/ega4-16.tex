\section{Differential invariants. Differentially smooth morphisms}
\label{section:IV.16}

\oldpage[IV-4]{5}
In this paragraph we will present, in global form, some notions of differential calculus particularly useful in algebraic geometry.
We will ignore many classic developments in differential geometry (connections, infinitesimal transformations associated to vector fields, jets, etc.), although these notions are translated in a particularly natural way for schemes.
We will similarly ignore phenomena exclusive to characteristic $p>0$ (some of which are seen, in the affine case, in \sref[0]{0.21}.
For certain complements to the differential formalism for preschemes the reader may consult Expos\'es~II and VII of \cite{IV-42} as well as subsequent chapters of this treatise. 

\subsection{Normal invariants of an immersion}
\label{IV.16.1}

\begin{env}[16.1.1]
\label{IV.16.1.1}
Let $(X, \sh{O}_X), (Y, \sh{O}_Y)$ be two ringed spaces and $f = (\psi, \theta): Y \to X$ a morphism of ringed spaces \sref[0]{0.4.1.1} such that the homomorphism
\[
  \theta^\#: \psi^*(\sh{O}_X) \to \sh{O}_Y
\]
is surjective, so that $\sh{O}_Y$ is identified with a sheaf of quotient rings $\psi^*(\sh{O}_X)/\sh{I}_f$. 
We can then endow $\psi^*(\sh{O}_X)$ with the $\sh{I}_f$-preadic filtration.
\end{env}

\begin{definition}[16.1.2]
\label{IV.16.1.2}
The $\sh{O}_Y$-augmented sheaf of rings $\psi^*(\sh{O}_X)/\sh{I}_f^{n+1}$ is called the $n$'th \emph{normal invariant} of $f$;
the ringed space $(Y, \psi^*(\sh{O}_X)/\sh{I}_f^{n+1})$ is called the $n$'th \emph{infinitesimal neighborhood} of $Y$ along $f$ and is denoted by $Y^{(n)}_f$ or simply $Y^{(n)}$.
The sheaf of graded rings associated to the sheaf of filtered rings $\psi^*(\sh{O}_X)$
\[
  \label{IV.16.1.2.1}
  \shGr_\bullet(f) = \bigoplus_{n \geq 0}(\sh{I}_f^{n}/\sh{I}_f^{n+1} )
  \tag{16.1.2.1}
\]
is called the sheaf of graded rings \emph{associated to} $f$. The sheaf $\shGr_1(f) = \sh{I}_f/\sh{I}_f^{2}$ is called the \emph{conormal sheaf} of $f$ (that will be denoted by $\sh{N}_{Y/X}$ when there is no risk of confusion). 
\end{definition}

It is clear that the $\sh{O}_{Y^{(n)}} = \psi^*(\sh{O}_X)/\sh{I}_f^{n+1}$ (that we also denote $\sh{O}_{Y_f^{(n)}})$ form a
\oldpage[IV-4]{6}
projective system of sheaves of rings on $Y$, the transition homomorphism $\phi_{nm}:\sh{O}_{Y^{(m)}} \to \sh{O}_{Y^{(n)}}$ for $n \leq m$ identifies $\sh{O}_{Y^{(n)}}$ with the quotient of $\sh{O}_{Y^{(m)}}$ by the power $(\sh{I}_f/\sh{I}_f^{n+1} )^m$ of the \emph{agumentation ideal} of $\sh{O}_{Y^{(n)}}$, kernel of $\phi_{0n}: \sh{O}_{Y^{(n)}} \to \sh{O}_{Y}$.
The $Y^{(n)}$ therefore form a inductive system of ringed spaces, all having underlying space $Y$, and we have canonical morphisms of ringed spaces $h_n: Y^{(n)} \to X$ equal to $(\psi, \theta_n)$, where $\theta^\#_n$ is the canonical morphism $\psi^*(\sh{O}_X) \to \psi^*(\sh{O}_X)/\sh{I}_f^{n+1}$.
It is clear that the sheaf $\shGr_\bullet(f)$ is a sheaf of graded algebras over the sheaf of rings $\sh{O}_Y = \shGr_0(f)$ and the $\shGr_k(f)$ of $\sh{O}_Y$-modules.

As with every sheaf of filtered rings, we have a \emph{canonical surjective homomorphism} of graded $\sh{O}_Y$-algebras
\[
  \label{IV.16.1.2.2}
  \bb{S}_{\sh{O}_Y}^\bullet(\shGr_1(f)) \to \shGr_\bullet(f)
  \tag{16.1.2.2}
\]
which coincide in degrees $0$ and $1$ with the identities.

\begin{examples}[16.1.3]
\label{IV.16.1.3}
\medskip\noindent
\begin{enumerate}
  \item[(i)] Suppose that $X$ is a locally ringed space, $Y$ is reduced to a single point $y$ (endowed with a ring $\sh{O}_y$) and that, if $x = \psi(y)$, $\theta^\#:\sh{O}_x \to \sh{O}_y$ is a \emph{surjective} homomorphism of rings having as kernel the maximal ideal $\mathfrak{m}_x$ of $\sh{O}_x$.
  So the $\sh{O}_{Y^{(n)}}$ are identified with the rings $\sh{O}_x/\mathfrak{m}_x^{n+1}$ and $\shGr_\bullet(f)$ with the graded ring associated with the local ring $\sh{O}_x$ endowed with the $\mathfrak{m}_x$-preadic filtration.
  \item[(ii)] Suppose that $Y$ is a closed subset of an open subspace $U$ of $X$ and that the $\sh{O}_Y$ is induced on $Y$ by a quotient sheaf $\sh{O}_U/\sh{I}$, where $\sh{I}$ is an ideal of $\sh{O}_U$ such that $\sh{I}_x = \sh{O}_x$ for every $x \not\in Y$;
  if $X$ is a locally ringed space we also suppose that $\sh{I}_x \neq \sh{O}_x$ for $y \in Y$ so that $(Y, \sh{O}_Y)$ is a locally ringed space.
  
  Let $\psi_0: Y \to U$ be the canonical injection and denote by $\theta_0: \sh{O}_U \to (\psi_0)_*(\sh{O}_Y)$ the homomorphism such that $\theta_0^\#$ is the canonical homomorphism $\psi^*_0(\sh{O}_U) = \sh{O}_U|Y \to (\sh{O}_U/\sh{I})|Y$, so that $j_0=(\psi_0, \theta_0):Y \to U$ is a morphism of ringed spaces (and of locally ringed spaces if $X$ is a locally ringed space);
  if $i:U \to X$ is the canonical injection (morphism of ringed spaces), $j = i\circ j_0$ is the morphism $(\psi, \theta)$ of $Y$ to $X$ where $\psi: Y \to X$ is the canonical injection and $\theta:\sh{O}_X \to \psi_*(\sh{O}_Y)$ is the homomorphism such that $\theta^\# = \theta_0^\#$.
  Since $\theta^\#$ is surjective we can apply the previous definitions;
  $\sh{O}_{Y^{(n)}}$ is equal to $\psi^*_0(\sh{O}_U/\sh{I}^{n+1})$, and we have $(\psi_0)_*(\sh{O}_{Y^{(n)}} ) = \sh{O}_U/\sh{I}^{n+1}$, and $\shGr_n(j) = \shGr_n(j_0) = \psi^*_0(\sh{I}^n/\sh{I}^{n+1}) = j^*_0(\sh{I}^n/\sh{I}^{n+1})$.
\end{enumerate}
\end{examples}

\begin{env}[16.1.4]
\label{IV.16.1.4}
The example \sref{IV.16.1.3}[(ii)] shows that in general the $\sh{O}_{Y^{(n)}}$ are \emph{not canonically endowed with a structure of an $\sh{O}_Y$-module}, or \emph{a fortiori} with a structure of an $\sh{O}_Y$-algebra.
The data of such structure is equivalent to the data of a homomorphism of sheaves of rings $\lambda_n:\sh{O}_Y \to \sh{O}_{Y^{(n)}}$, right inverse to the augmentation morphism $\phi_{0n}$;
it is also equivalent to the data of a morphism of ringed spaces $(1_Y, \lambda_n): Y^{(n)} \to Y$ left inverse to the canonical morphism $(1_Y, \phi_{0n}): Y \to Y^{(n)}$.
\end{env}

\begin{proposition}[16.1.5]
\label{IV.16.1.5}
Let $f = (\psi, \theta): Y \to X$ be an immersion of preschemes.
Then:
\begin{enumerate}
  \item[{\rm(i)}] $\shGr_\bullet(f)$ is a quasi-coherent graded $\sh{O}_Y$-algebra.
\oldpage[IV-4]{7}
  \item[{\rm(ii)}] The $Y^{(n)}$ are preschemes, canonically isomorphic to subpreschemes of $X$.
  \item[{\rm(iii)}] Every homomorphism of sheaves of rings $\lambda_n: \sh{O}_Y \to \sh{O}_{Y^{(n)}}$, right inverse to the augmentation homomorphism $\phi_{0n}$, makes the $\sh{O}_{Y^{(n)}}$ and $\sh{O}_{Y^{(k)}}$ for $k\leq n$ quasi-coherent $\sh{O}_Y$-algebras;
  the $\sh{O}_Y$-module structures induced from the above structures on the $\shGr_k(f)$ for $k \leq n$ coincide with the ones defined in \sref{IV.16.1.2}.
\end{enumerate}
\end{proposition}

\begin{proof}
(i) Since the question is local on $X$ and $Y$, we can reduce to the case where $Y$ is a closed subpreschemes of $X$ defined by an quasi-coherent ideal $\sh{I}$ of $\sh{O}_X$;
since $\sh{O}_Y$ is the restriction to $Y$ of $\sh{O}_X/\sh{I}$ the assertion (i) is evident, and $Y^{(n)}$ is the closed subprescheme of $X$ defined by the quasi-coherent ideal $\sh{I}^{n+1}$ of $\sh{O}_X$.
Finally, to prove (iii) we notice that the data of $\lambda_n$ makes the ideal $\sh{I}/\sh{I}^n$ of the augmentation $\phi_{0n}$ and their quotients $\sh{I}/\sh{I}^{k+1} (1\leq k \leq n)$ $\sh{O}_Y$-modules, and it suffices to prove by induction on $k$ that the $\sh{I}/\sh{I}^{k+1}$ are quasi-coherent $\sh{O}_Y$-modules and the structure of quotient $\sh{O}_Y$-module induced on $\sh{I}^k/\sh{I}^{k+1}$ is the same as defined on \sref{IV.16.1.2}.
The second assertion is immediate, $\sh{I}^k/\sh{I}^{k+1}$ being killed by $\sh{I}/\sh{I}^{n+1}$;
the first result, by induction on $k$, is trivial for $k=1$ and for $\sh{I}/\sh{I}^{k+1}$ being an extension of $\sh{I}/\sh{I}^{k}$ by $\sh{I}^k/\sh{I}^{k+1}$ \sref{III.1.4.17}.
\end{proof}

\begin{corollary}[16.1.6]
\label{IV.16.1.6}
Under the general hypotheses of \sref{IV.16.1.5}, if the immersion $f$ is locally of finite presentation then the $\shGr_n(f)$ are quasi-coherent $\sh{O}_Y$-modules of finite type.
\end{corollary}

\begin{proof}
Indeed, with the notation from the proof of \sref{IV.16.1.5}, $\sh{I}$ is an ideal of finite type of $\sh{O}_X$ \sref{IV.1.4.7}, therefore the $\sh{I}^n/\sh{I}^{n+1}$ are $\sh{O}_Y$-modules of finite type, hence the conclusion.
\end{proof}

\begin{corollary}[16.1.7]
\label{IV.16.1.7}
Under the general hypotheses of \sref{IV.16.1.5}, let $g:X \to Y$ be a morphism of preschemes, left inverse to $f$.
Therefore, for every $n$, the composite morphism $(1, \lambda_n): Y^{(n)}\xrightarrow{h_n} X \xrightarrow{g} Y$ defines a homomorphism of sheaves of rings $\lambda_n: \sh{O}_Y \to \sh{O}_{Y^{(n)}}$ right inverse to the augmentation $\phi_{0n}$, making $\sh{O}_{Y^{(n)}}$ a quasi-coherent $\sh{O}_Y$-algebra;
via these homomorphisms, the transition homomorphism $\phi_{nm}:\sh{O}_{Y^{(m)}} \to \sh{O}_{Y^{(n)}}$ ($n\leq m$) are homomorphisms of $\sh{O}_Y$-algebras. 
Also, if $g$ is locally of finite type, then the $\sh{O}_{Y^{(n)}}$ are quasi-coherent $\sh{O}_Y$-modules of finite type.
\end{corollary}

\begin{proof}
The first assertion is an immediate result from the definitions and \sref{IV.16.1.5}.
On the other hand, if $g$ is locally of finite type, then $f$ is locally of finite presentation \sref{IV.1.4.3}[(v)];
the $\shGr_n(f)$ being then quasi-coherent $\sh{O}_Y$-modules of finite type by \sref{IV.16.1.6}, the same goes for the $\sh{O}_Y$-modules $\sh{I}/\sh{I}^{n+1}$, being extensions of a finite number of the $\shGr_k(f)$ \sref[III]{III.1.4.17}.
\end{proof}

\begin{proposition}[16.1.8]
\label{IV.16.1.8}
Let $X$ be a locally Noetherian prescheme, $j:Y \to X$ an immersion;
Then the $Y^{(n)}$ are locally Noetherian preschemes, the $\shGr_n(j)$ are coherent $\sh{O}_Y$-modules and the $\shGr_\bullet(j)$ is a coherent sheaf of rings over the space $Y$.
\end{proposition}

\begin{proof}
Everything is local on $X$ and $Y$, so we reduce to the case where $X$ is affine and $j$ is a closed immersion and therefore all the assertions are evident except for the last, which follows from the fact that if $A$ is a Noetherian ring and $\mathfrak{I}$ is an ideal of $A$, then $\gr_\mathfrak{I}^\bullet(A)$ is a Noetherian ring, taking into account the exactness of the functor $\psi^*$ and \sref[0]{0.5.3.7}.
\end{proof}

\begin{proposition}[16.1.9]
\label{IV.16.1.9}
\oldpage[IV-4]{8}
Let $X$ be a prescheme, $j: Y \to X$ an immersion locally of finite presentation, $y$ a point of $Y$. The following conditions are equivalent:
\begin{enumerate}
  \item[(a)] There exists an open neighborhood $U$ of y in $Y$ such that $j|U$ is a homeomorphism of $U$ onto an open set of $X$.
  \item[(b)] There is an integer $n>0$ such that the canonical homomorphism
  \[
    (\phi_{n-1,n})_y: \sh{O}_{Y^{(n)},y} \to \sh{O}_{Y^{(n-1)},y}
  \]
  is bijective.
  \item[(c)] There is an integer $n>0$ such that $(\shGr_n(j))_y = 0$.
  
  In addition, if the integer $n$ satisfies \emph{(b)} or \emph{(c)}, then there is a neighborhood $V$ of $y$ in $Y$ such that $\shGr_m(j)|V = 0$ for $m \geq n$ and that $\phi_{nm}|V: \sh{O}_{Y^{(m)}}|V \to \sh{O}_{Y^{(n)}}|V$ is bijective for $m \geq n$. 
\end{enumerate}
\end{proposition}

\begin{proof}
The question being local on $Y$, we can restrict ourselves to the case where $j$ is a closed immersion, $Y$ being defined by a quasi-coherent ideal \emph{of finite type} $\mathfrak{I}$ of $\sh{O}_X$.
The equivalence of (b) and (c), for a given $n$, is immediate;
also, since $\sh{I}^n/\sh{I}^{n+1}$ is an $\sh{O}_X$-module of finite type, there is an open neighborhood $U$ of $y$ in $X$ such that $\sh{I}^n|U = \sh{I}^{n+1}|U$ \sref[0]{0.5.2.2}, so we also have $\sh{I}^n|U = \sh{I}^m|U$ for $m \geq n$ proving the last assertions.
To prove that (a) implies (b), we can restrict ourselves to the cases where the underlying space of $Y$ is equal to the underlying space of $X$ and where $\sh{I}$ is generated by a finite number of sections over $X$:
since $\sh{I}$ is contained in the nilradical $\sh{N}$ of $\sh{O}_X$ \sref[I]{I.5.1.2}, it is now nilpotent which proves b).
Finally, to prove that (b) implies (a), we can restrict ourselves to the case where $\sh{I}^n = \sh{I}^m$; 
therefore, for every $y \in Y$, since $\sh{I}_y \subset \mathfrak{m}_y$, maximal ideal of $\sh{O}_{X,y}$, we must have $\sh{I}^n_y = 0$ because of Nakayama's lemma, since $\sh{I}_y$ is an ideal of finite type.
The set of $x \in X$ such that $\sh{I}^n_x = 0$ is an open $U$ of $X$ contained in $Y$ \sref[0]{0.5.2.2};
since on the other hand $\sh{I}_x \neq 0$ for $x \notin Y$, we must have $U = Y$.
\end{proof}

\begin{corollary}[16.1.10]
\label{IV.16.1.10}
For a restriction of the immersion $j$ to an open neighborhood of $y$ in $Y$ to be an open immersion (in other words, for $j$ to be a \emph{local isomorphism} on the point $y$), it is necessary and sufficient that $(\shGr_1(j))_y = (\sh{N}_{Y/X})_y = 0$.
\end{corollary}

\begin{proof}
The condition is clearly necessary, and the previous reasoning applied to $n=1$ proves that it is sufficient.
\end{proof}

\begin{remark}[16.1.11]
\label{IV.16.1.11}
\medskip\noindent
\begin{enumerate}
  \item[(i)] Under the conditions of the definition \sref{IV.16.1.1}, the projective limit of the projective system $(\sh{O}_{Y^{(n)}}, \phi_{nm})$ of sheaves of rings over $Y$ is called the \emph{normal invariant of infinite order} of $f$, and sometimes denoted by $\sh{O}_{Y^{(\infty)}}$.
  When $X$ is a locally noetherian prescheme, $j:Y \to X$ a closed immersion, $Y$ then is a closed subprescheme of $X$ defined by a coherent ideal $\sh{I}$ and $\sh{O}_{Y^{(\infty)}}$ is exactly the \emph{formal completion} of $\sh{O}_X$ along $Y$ \sref[I]{I.10.8.4}, and $Y^{(\infty)} = (Y, \sh{O}_{Y^{(\infty)}})$ is the formal prescheme that is the \emph{completion} of $X$ along $Y$ \sref[I]{I.10.8.5}.
  In all cases, we could say that $Y^{(\infty)}$ is the \emph{formal neighborhood} of $Y$ in $X$ (via the morphism $f$).
  In the particular case we have just considered, it is the formal prescheme that is the inductive limit of the infinitesimal neighborhoods of order $n$.
  \item[(ii)] Note that for a morphism of preschemes $f=(\psi, \theta): Y \to X$, it can happen that the homomorphism $\theta^\#:\psi^*(\sh{O}_X) \to \sh{O}_Y$ is surjective without $f$ being a local 
\oldpage[IV-4]{9}
  immersion and without $f$ being injective.
  We have an example by taking $Y$ to be a sum of preschemes $Y_\lambda$ all isomorphic to $\Spec(\sh{O}_x)$, where $x \in X$, ad taking $f$ to be the morphism equal to the canonical morphism in each of the $Y_\lambda$.
\end{enumerate}
\end{remark}

\subsection{Functorial properties of the normal invariants of an immersion}
\label{IV.16.2}

\begin{env}[16.2.1]
\label{IV.16.2.1}
Let $f = (\psi, \theta): Y \to X$ and $f' = (\psi', \theta'): Y' \to X'$ by two morphisms of ringed spaces such that $\theta^\#$ and $\theta'^\#$ are surjective;
consider a commutative diagram of morphisms of ringed spaces
\[
  \label{IV.16.2.1.1}
  \xymatrix{
    Y \ar[r]^f & X \\
    Y'\ar[r]_{f'} \ar[u]^u & X'\ar[u]_v  
  }
  \tag{16.2.1.1}
\]

Let $u = (\rho, \lambda), v = (\sigma, \mu)$. 
We have $\rho^*(\psi^*(\sh{O}_X)) = \psi'^*(\sigma^*(\sh{O}_X))$ and as a result a commutative diagram of homomorphisms of sheaves of rings over $Y'$
\[
  \xymatrix{
    \rho^*(\psi^*(\sh{O}_X)) = \psi'^*(\sigma^*(\sh{O}_X)) \ar[r]^-{\psi'^*(\mu^\#)}\ar[d]_{\rho^*(\theta^\#)} & \psi'^*(\sh{O}_{X'}) \ar[d]^{\theta'^\#} \\
    \rho^*(\sh{O}_Y)\ar[r]_-{\lambda^\#}  & \sh{O}_{Y'}  
  }
\]
from which we conclude, if $\sh{I}$ and $\sh{I'}$ are the kernels of $\theta^\#$ and $\theta'^\#$, that we have $\psi'^*(\mu^\#)(\rho^*(\sh{I})) \subset \sh{I'}$, having in mind the exactness of the functor $\rho^*$.
We deduce that, for every integer $n$, $\psi'^*(\mu^\#)(\rho^*(\sh{I}^n)) \subset \sh{I'}^n$, which shows that $\psi'^*(\mu^\#)$ defines, passing to the quotients, a homomorphism of sheaves of rings
\[
  \label{IV.16.2.1.2}
  \nu_n: \rho^*(\psi^*(\sh{O}_X)/\sh{I}^{n+1}) \to \psi'^*(\sh{O}_{X'})/\sh{I'}^{n+1}
  \tag{16.2.1.2}
\]
and therefore a morphism of ringed spaces $w_n = (\rho, \nu_n): Y'^{(n)} \to Y^{(n)}$ (which, for $n = 0$, is none other than $u$).
It follows immediately from this definition that the diagrams
\[
  \xymatrix@R=1pc{
    Y^{(n)} \ar[r]^-{h_{mn}} & Y^{(m)} \ar[r]^-{h_m} & X \\
    & & & (n \leq m) \\
    Y'^{(n)} \ar[r]_-{h'_{mn}} \ar[uu]^-{w_n} & Y'^{(m)} \ar[r]_-{h'_m} \ar[uu]^-{w_m} & X' \ar[uu]_-v \\
  }
\]
(where the horizontal arrows are the canonical morphisms \sref{IV.16.1.2}) are commutative.

By passage to the quotients via the morphisms \sref{IV.16.2.1.2}, and taking into
\oldpage[IV-4]{10}
account the exactness of the functor $\rho^*$, we obtain a di-homomorphism of graded algebras (relative to the morphism $\lambda^\#: \rho^*(\sh{O}_Y) \to \sh{O}_{Y'}$)
\[
  \label{IV.16.2.1.3}
  \gr(u): \rho^*(\shGr_\bullet(f)) \to \shGr_\bullet(f')
  \tag{16.2.1.3}
\]
(or, if you like, a $\rho$-morphism \sref[0]{0.3.5.1} $\shGr_\bullet(f) \to \shGr_\bullet(f')$), and in particular a di-homomorphism of conormal sheafs
\[
  \gr_1(u): \rho^*(\shGr_1(f)) \to \shGr_1(f').
\]

It is also immediate that these homomorpisms give rise to a commutative diagram
\[
  \label{IV.16.2.1.4}
  \xymatrix{
    \rho^*(\bb{S}_{\sh{O}_Y}^\bullet(\shGr_1(f))) \ar[r] \ar[d]_-{\bb{S}(\gr_1(u))} & \rho^*(\shGr_\bullet(f)) \ar[d]^-{\gr(u)}\\
    \bb{S}_{\sh{O}_Y}^\bullet(\shGr_1(f')) \ar[r] & \shGr_\bullet(f')
  }
  \tag{16.2.1.4}
\]
where the horizontal arrow are the canonical morphisms \sref{IV.16.1.2.2}.

Finally, if we have a commutative diagram of morphisms of ringed spaces
\[
  \xymatrix{
    Y \ar[r]^{f} & X \\
    Y' \ar[r]_{f'} \ar[u]^u & X' \ar[u]_v\\
    Y'' \ar[r]_{f''} \ar[u]^{u'} & X'' \ar[u]_{v'}\\
  }
\]
where $f'' = (\psi'', \theta'')$ is such that $\theta''^\#$ is surjective, and if $w_n'$ and $w_n''$ are defined from $u'$, $v'$ for one and $u'' = u \circ u'$, $v'' = v \circ v'$ for the other, we have $w_n'' = w_n \circ w_n'$, which follows immediately from the definitions and from \sref[0]{0.3.5.5};
we have also $\gr(u'') = \gr(u') \circ \rho'^*(\gr(u))$ if $u' = (\rho', \lambda')$.
Therefore we can say that $Y^{(n)}$ and $\shGr_\bullet(f)$ \emph{depend functorially} on $f$. 
\end{env}

\begin{proposition}[16.2.2]
\label{IV.16.2.2}
With the notation and hypotheses of \sref{IV.16.2.1}, suppose also that $f$, $f'$, $u$, and $v$ are morphisms of preschemes. We have:
\begin{enumerate}
  \item[{\rm(i)}] The morphisms $w_n:Y'^{(n)} \to Y^{(n)}$ are morphisms of preschemes.
  \item[{\rm(ii)}] If $Y' = Y \times_X X'$, $u$ and $f'$ the canonical projections, and if $f$ is an immersion or if $v$ is flat, we have $Y'^{(n)} = Y^{(n)} \times_X X'$.
  \item[{\rm(iii)}] If $Y' = Y \times_X X'$ and if $v$ is flat (resp. if $f$ is an immersion), the homomorphism 
  \[
    \Gr(u) = \gr(u)\otimes I : \shGr_\bullet(f)\otimes_{\sh{O}_Y}\sh{O}_{Y'} \to \shGr_\bullet(f')
  \]
  is bijective (resp. surjective).
\end{enumerate}
\end{proposition}

\begin{proof}
\medskip\noindent
\begin{enumerate}
  \item[(i)] The hypotheses immediately imply that, for every $y' \in Y'$, $\rho_{y'}^*(\theta_{\psi'(y')}^\#)$ is a \emph{local} homomorphism \sref[I]{I.1.6.2}, so $w_n$ is a morphism of preschemes \sref[I]{I.2.2.1}.
  \oldpage[IV-4]{11}
  \item[(ii) and (iii)] If $f$ is an immersion, we can restrict ourselves to the case where $f$ is a closed immersion, $Y$ being defined by a quasi-coherent ideal $\sh{I}$ of $\sh{O}_X$ and $Y^{(n)}$ by the ideal $\sh{I}^{n+1}$;
  the assertions follows from \sref[I]{I.4.4.5}.

  Second, suppose that $v$ is flat;
  we can restrict ourselves to the case where $X = \Spec(A)$, $Y = \Spec(B)$, $X' = \Spec(A')$ are affines, $A'$ being a flat $A$-module;
  so $Y' = \Spec(B')$ where $B' = B \otimes_A A'$;
  in addition, if $\mathfrak{I}$ is the kernel of the homomorphism $A \to B$, the kernel $\mathfrak{I'}$ of $A' \to B'$ is identified with $\mathfrak{I}\otimes_A A'$ by flatness, and $\sh{I}'^n/\sh{I'}^{n+1}$ is equal to
  \begin{align*}
    \psi'^*(\sigma^*((\mathfrak{I}^n/\mathfrak{I}^{n+1})^\sim) \otimes_{\sigma^*(\sh{O}_X)} \sh{O}_{X'}) =& \\
    \psi'^*(\sigma^*((\mathfrak{I}^n/\mathfrak{I}^{n+1} ))^\sim) \otimes_{\psi'^*(\sigma^*(\sh{O}_X))} &\psi'^*(\sh{O}_{X'}) = \rho^*(\sh{I}^n/\sh{I}^{n+1})\otimes_{\rho^*(\psi^*(\sh{O}_X))} \psi'^*(\sh{O}_{X'}) 
  \end{align*}
  and in particular for $n = 0$, we have
  \[
    \sh{O}_{Y'} = \rho^*(\sh{O}_Y) \otimes_{\rho^*(\psi^*(\sh{O}_X))} \psi'^*(\sh{O}_{X'})
  \]
  from which we have canonical isomorphism of $\sh{I}'^n/\sh{I'}^{n+1}$ with
  \[
    \rho^*(\sh{I}^n/\sh{I}^{n+1})\otimes_{\rho^*(\sh{O}_Y)} \sh{O}_{Y'} = (\sh{I}^n/\sh{I}^{n+1}) \otimes_{\sh{O}_Y} \sh{O}_{Y'}
  \]
  which proves (iii).
  Let now $C_n = \Gamma(Y, \sh{O}_{Y^{(n)}}), C'_n = \Gamma(Y', \sh{O}_{Y'^{(n)}})$.
  As $Y^{(n)}$ and $Y'^{(n)}$ are affine schemes \sref{IV.16.1.5}, the kernel $\mathfrak{K}_n$ (resp. $\mathfrak{K}'_n$) of the homomorphism $C_n \to C_{n-1}$ (resp. $C'_n \to C'_{n-1}$) is $\Gamma(Y, \sh{I}^n/\sh{I}^{n+1})$ (resp. $\Gamma(Y, \sh{I}'^n/\sh{I'}^{n+1})$);
  therefore we can deduce from the above results that $\mathfrak{K}'_n = \mathfrak{K}_n \otimes_A A'$.
  Now, we have a commutative diagram
  \[
    \xymatrix{
      0 \ar[r] & \mathfrak{K}_n \ar[d]^-r\ar[r] \otimes_A A' & C_n \otimes_A A' \ar[d]^-{s_n}\ar[r] & C_{n-1} \otimes_A A' \ar[d]^-{s_{n-1}}\ar[r] & 0 \\
      0 \ar[r] & \mathfrak{K}'_n \ar[r] & C'_n \ar[r] & C'_{n-1} \ar[r] & 0
    }
  \]
  where the vertical arrow of the left is bijective and the two lines are exact ($A'$ being a flat $A$-module).
  We deduce by induction that $s_n$ is bijective for every $n$, because it is true by hypothesis for $n = 0$, and is deduced by application of the five lemma for all $n$.
  That proves the second assertion of (ii).
\end{enumerate}
\end{proof}

\begin{corollary}[16.2.3]
\label{IV.16.2.3}
Let $g: X \to Y$, $u: Y' \to Y$ be two morphisms of preschemes, $X' = X \times_Y Y'$, $g': X' \to Y'$ and $v: X' \to X$ by the canonical projections. Let $f: Y \to X$ by a $Y$-section of $X$ (and therefore an immersion), $f' = f_{(Y')}: Y' \to X'$ the $Y'$-section of $X'$ deduced from $f$ by the base change $u$.
We have:
\begin{enumerate}
  \item[{\rm(i)}] The morphism $w_n:{Y'_{f'}}^{(n)} \to Y_f^{(n)}$ corresponding to $f$, $f'$, $u$, $v$ \sref{IV.16.2.1} and the canonical morphism $h'_n: {Y'_{f'}}^{(n)} \to X'$ identifies $ {Y'_{f'}}^{(n)}$ with the product $Y_f^{(n)} \times_X X'$.
  \item[{\rm(ii)}] If we endow $\sh{O}_{Y_f^{(n)}}$ (resp. $\sh{O}_{{Y'_{f'}}^{(n)}}$) with the structure of an $\sh{O}_Y$-algebra defined by $g$ (resp. with the structure of an $\sh{O}_{Y'}$-algebra defined by $g'$ ) \sref{IV.16.1.5}[(iii)],
  % The original citation is IV.16.1.6, but he clearly meant 16.1.5 item (iii)
  then the homomorphism of $\sh{O}_{Y'}$-algebras
  \[
    \label{IV.16.2.3.1}
    \rho^*(\sh{O}_{Y_f^{(n)}})\otimes_{\sh{O}_Y} \sh{O}_{Y'} \to \sh{O}_{{Y'_{f'}}^{(n)}}
    \tag{16.2.3.1}
  \]
\oldpage[IV-4]{12}
  induced by the homomorphism $\nu_n$ \sref{IV.16.2.1.2} is bijective.
  Also, the homomorphism of $\sh{O}_{Y'}$-modules
  \[
    \label{IV.16.2.3.2}
    \Gr_1(u): \shGr_1(f)\otimes_{\sh{O}_Y} \sh{O}_{Y'} \to \shGr_1(f')
    \tag{16.2.3.2}
  \]
  is bijective.
 \end{enumerate} 
\end{corollary}

\begin{proof}
\medskip\noindent
\begin{enumerate}
  \item[(i)] Let us first note that $f': Y' \to X'$ and $u: Y' \to Y$  identifies $Y'$ with the product $Y \times_X X'$ (via the structure morphisms $f:Y \to X$ and $v: X' \to X$) \sref{IV.14.5.12.1}.
  The conclusion of (i) now follows from \sref{IV.16.2.2}[(ii)], the morphism $g$ being an immersion.
  \item[(ii)] The commutative diagram
  \[
  \xymatrix{
    Y_f^{(n)} \ar[d]^{h_n}  & {Y'_{f'}}^{(n)} \ar[d]^-{h'_n} \ar[l]^{w_n}\\  
    X         \ar[d]^{g}    & X'              \ar[d]^{g'} \ar[l]^v \\  
    Y                       & Y' \ar[l]^u \\  
  }
  \]
  identifies ${Y'_{f'}}^{(n)}$ with the product $Y_f^{(n)} \times_X X'$, so \sref[I]{I.3.3.9} it identifies (via the morphisms $g'\circ h'_n$ and $w_n$) ${Y'_{f'}}^{(n)}$ to the product $Y_f^{(n)} \times_Y Y'$.
  Since $Y_f^{(n)}$ (resp. ${Y'_{f'}}^{(n)}$) is the affine prescheme over $Y$ (resp. over $Y'$) associated with the $\sh{O}_Y$-algebra $\sh{O}_{Y_f^{(n)}}$ (resp. to the $\sh{O}_{Y'}$-algebra $\sh{O}_{{Y'_{f'}}^{(n)}}$), the fact that the canonical homomorphism \sref{IV.16.2.3.1} is bijective follows from \sref[II]{II.1.5.2}.
  Finally, the canonical homomorphism \sref{IV.16.2.3.1} is compatible with the augmentations $\sh{O}_{Y_f^{(n)}} \to \sh{O}_Y$ and $\sh{O}_{{Y'_{f'}}^{(n)}} \to \sh{O}_{Y'}$;
  since $\sh{O}_{Y_f^{(n)}}$ is a direct sum (as an $\sh{O}_Y$-module) of $\sh{O}_Y$ and the augmentation ideal $\sh{I}/\sh{I}^{n+1}$, we can therefore see that the canonical homomorphism \sref{IV.16.2.3.1}, restricted to $\sh{I}/\sh{I}^{n+1} \otimes_{\sh{O}_Y} \sh{O}_{Y'}$, is a bijection of the latter onto $\sh{I}'/\sh{I}'^{n+1}$. For $n=1$ this shows that $\Gr_1(u)$ is bijective.
\end{enumerate}
\end{proof}

We note that, under the hypotheses of \sref{IV.16.2.3}, the homomorphisms $\Gr_n(u)$ are \emph{surjective} in view of the above, but are not bijective in general for $n \geq 2$.
However:

\begin{corollary}[16.2.4]
\label{IV.16.2.4}
Under the hypotheses of \sref{IV.16.2.3}, suppose that $u: Y' \to Y$ is a flat morphism (resp. that the $\shGr_n(f)$ are flat $\sh{O}_Y$-modules for $n \leq m$).
Then the homomorphism 
\[
  \Gr_n(u):\shGr_n(f) \otimes_{\sh{O}_Y}\sh{O}_{Y'} \to \shGr_n(f')
\]
is bijective for all $n$ (resp. for $n \leq m$).
\end{corollary}

\begin{proof}
If $u$ is flat, then we deduce by base change that the same is true for $v:X' \to X$, and we already know in this case that $\Gr(u)$ is bijective \sref{IV.16.2.2}[(iii)].
If the $\shGr_n(f)$ are flat for $n\leq m$, then we first see by induction on $n$ that the same holds for $\sh{I}/\sh{I}^{n+1}$ for $n\leq m$, because of the exact sequences
  \[
    \xymatrix{
      0 \ar[r] & \sh{I}^n/\sh{I}^{n+1} \ar[r] & \sh{I}/\sh{I}^{n+1} \ar[r] & \sh{I}/\sh{I}^{n} \ar[r] & 0
    }
  \]
\oldpage[IV-4]{13}
  \sref[0]{0.6.1.2};
  in addition, we have the commutative diagram
  \[
    \xymatrix{
      0 \ar[r] & (\sh{I}^n/\sh{I}^{n+1}) \otimes_{\sh{O}_Y}\sh{O}_{Y'} \ar[d]\ar[r] &( \sh{I}/\sh{I}^{n+1}) \otimes_{\sh{O}_Y}\sh{O}_{Y'} \ar[d]\ar[r] & (\sh{I}/\sh{I}^{n}) \otimes_{\sh{O}_Y}\sh{O}_{Y'} \ar[d]\ar[r] & 0 \\
      0 \ar[r] & \sh{I'}^n/\sh{I'}^{n+1} \ar[r] & \sh{I'}/\sh{I'}^{n+1} \ar[r] & \sh{I'}/\sh{I'}^{n} \ar[r] & 0
    }
  \]
  in which the lines are exact (the first by flatness \sref[0]{0.6.1.2}) and the two last vertical arrows are bijective by virtue of \sref{IV.16.2.2}[(ii)];
  hence the conclusion.
\end{proof}

\begin{remarks}[16.2.5]
\label{IV.16.2.5}
\medskip\noindent
\begin{enumerate}
  \item[(i)] The reasoning of \sref{IV.16.2.2}[(i)] still applies to \sref{IV.16.2.1.1} when these are morphisms of \emph{locally ringed spaces} \sref[I]{I.1.8.2}.
  \item[(ii)] In \sref{IV.16.2.2}[(ii)], the conclusion is no longer necessairly valid if we only suppose that $v$ and $f$ are morphisms of preschemes ($f$ satisfying the condition of \sref{IV.16.1.1}).
  For example (with the notation of the proof of \sref{IV.16.2.2}[(ii)]), it can happen that $\mathfrak{I} = 0$ but the kernel $\mathfrak{I}'$ of $A' \to B' = B \otimes_A A'$ is not zero and that $B' \neq 0$, in which case we have $Y^{(n)} = Y$ for all $n$, but ${Y'}^{(n)} \neq Y'$.
  We have an example of this by taking $A = \bb{Z}$, $B = \bb{Q}$, $A' = \prod_{h = 1}^\infty (\bb{Z}/m^h\bb{Z})$ where $m>1$.
\end{enumerate}
\end{remarks}

\begin{env}[16.2.6]
\label{IV.16.2.6}
Consider the particular case of the diagram \sref{IV.16.2.1.1} where $X' = X$, $v$ is the identity, $X$ a prescheme, $Y$ a subprescheme of $X$, $Y'$ a subprescheme of $Y$, $f$, $u$, and $f' = f \circ u$ the canonical injections;
the di-homomorphism \sref{IV.16.2.1.3} gives us, by tensoring with $\sh{O}_{Y'}$ over $\rho^*(\sh{O}_Y)$, a homomorphism of graded $\sh{O}_{Y'}$-algebras
\[
  \label{IV.16.2.6.1}
  u^*(\shGr_\bullet(f)) \to \shGr_\bullet(f').
  \tag{16.2.6.1}
\]
On the other hand, we identify $\sh{O}_Y$ to $\psi^*(\sh{O}_X)/\sh{I}_f$ and $\sh{O}_{Y'}$ to $\rho^*(\sh{O}_Y)/\sh{I}_u$;
since $\rho^*$ is an exact functor, we have $\rho^*(\sh{O}_Y) = \rho^*(\psi^*(\sh{O}_X))/\rho^*(\sh{I}_f) = \psi'^*(\sh{O}_X)/\rho^*(\sh{I}_f)$, and since $\sh{O}_{Y'}$ is moreover identified with $\psi'^*{\sh{O}_X}/\sh{I}_{f'}$, we see that $\sh{I}_u = \sh{I}_{f'}/\rho^*(\sh{I}_f)$.
We deduce that for every integer $n$ there is a canonical homomorphism $\sh{I}_{f'}^n/\sh{I}_{f'}^{n+1} \to \sh{I}_{u}^n/\sh{I}_{u}^{n+1}$, from which we have a canonical morphism of graded $\sh{O}_{Y'}$-algebras
\[
  \label{IV.16.2.6.2}
  \shGr_\bullet(f') \to \shGr_\bullet(u).
  \tag{16.2.6.2}
\]
\end{env}

\begin{proposition}[16.2.7]
\label{IV.16.2.7}
Let $X$ be a prescheme, $Y$ a subprescheme of $X$, $Y'$ a subprescheme of $Y$, $j:Y' \to Y$ the canonical injection.
We then have an exact sequence of conormal sheaves ($\sh{O}_{Y'}$-modules)
\[
  \label{IV.16.2.7.1}
  \xymatrix{
    j^*(\sh{N}_{Y/X}) \ar[r] & \sh{N}_{Y'/X} \ar[r] & \sh{N}_{Y'/Y} \ar[r] & 0
  }
  \tag{16.2.7.1}
\]
where the arrows are the degree $1$ components of the canonical homomorphisms \sref{IV.16.2.6.1} and \sref{IV.16.2.6.2}.
\end{proposition}

\begin{proof}
The problem being local, we can restrict to the case where $X = \Spec(A)$, $Y = \Spec(A/\mathfrak{I})$ and $Y' = \Spec(A/\mathfrak{K})$, $\mathfrak{I}$ and $\mathfrak{K}$ being ideals of $A$ such that $\mathfrak{I} \subset \mathfrak{K}$;
everything reduces to seeing 
\oldpage[IV-4]{14}
that the sequence of canonical morphisms $\mathfrak{I}/\mathfrak{K}\mathfrak{I} \to \mathfrak{K}/\mathfrak{K}^2 \to (\mathfrak{K}/\mathfrak{I})/(\mathfrak{K}/\mathfrak{I})^2 \to 0$ is exact, which is immediate given that the image of $\mathfrak{I}/\mathfrak{K}\mathfrak{I}$ in $\mathfrak{K}/\mathfrak{K}^2$ is $(\mathfrak{I} + \mathfrak{K}^2)/\mathfrak{K}^2$ and that $(\mathfrak{K}/\mathfrak{I})/(\mathfrak{K}/\mathfrak{I})^2$ is identified with $\mathfrak{K}/(\mathfrak{I} + \mathfrak{K}^2)$.
\end{proof}

It is easy to give examples where the sequence \sref{IV.16.2.7.1} extended on the left by $0$ is not exact;
with the above notation, it suffices to take $A = k[T]$, $\mathfrak{I} = AT^2$, $\mathfrak{K} = AT$, because then $(\mathfrak{I} + \mathfrak{K}^2)/\mathfrak{K}^2 = 0$ and $\mathfrak{I}/\mathfrak{K}\mathfrak{I} \neq 0$.
See however \sref{IV.16.9.13} and \sref{IV.19.1.5} for some cases where the extended sequence is indeed exact.

\subsection{Fundamental differential invariants of morphisms of preschemes}
\label{IV.16.3}

\begin{definition}[16.3.1]
\label{IV.16.3.1}
Let $f:X \to S$ be a morphism of preschemes, $\Delta_f: X \to X \times_S X$ the corresponding diagonal morphism, which is an immersion \sref[I]{I.5.3.9}.
We denote by $\sh{P}_f^n$ or $\sh{P}_{X/S}^n$, and call the \emph{sheaf of principal parts of order $n$ of the $S$-prescheme $X$}, the $\sh{O}_X$-augmented sheaf of rings, $n$-th normal invariant of $\Delta_f$ \sref{IV.16.1.2}.
We will also write $\sh{P}_f^\infty = \sh{P}_{X/S}^\infty = \varprojlim_n \sh{P}_{X/S}^n$, $\shGr_n(\sh{P}_f) = \shGr_n(\sh{P}_{X/S}) = \shGr_n(\Delta_f)$ \sref{IV.16.1.2};
the $\sh{O}_X$-module $\shGr_1(\Delta_f)$, augmentation sheaf of ideals of $\sh{P}_{X/S}^1$, is denoted by $\Omega_f^1$ or $\Omega_{X/S}^1$, and is called the $\sh{O}_X$-module of \emph{$1$-differentials} of $f$, or of $X$ with respect to $S$, or of the $S$-prescheme $X$.
\end{definition}

It follows from this definition that $\sh{P}_{X/S}^0$ is canonically identified with $\sh{O}_X$ \sref{IV.16.1.2}.

We have \sref{IV.16.1.2.2} a canonical surjective morphism of graded $\sh{O}_X$-algebras 
\[
  \label{IV.16.3.1.1}
  \bb{S}_{\sh{O}_X}^\bullet(\Omega_{X/S}^1) \to \shGr_\bullet(\sh{P}_{X/S}).
  \tag{16.3.1.1}
\]
And it follows from Definition~\sref{IV.16.3.1} that for every open $U$ of $X$ we have $\sh{P}_{f|U}^n = \sh{P}_f^n|U$, $\sh{P}_{f|U}^\infty = \sh{P}_f^\infty|U$, $\shGr_n(\sh{P}_{f|U}) = \shGr_n(\sh{P}_f)|U$, $\Omega_{f|U}^1 = \Omega_f^1|U$ (in other words, the notions introduced are \emph{local} on $X$).

\begin{env}[16.3.2]
\label{IV.16.3.2}
Denote by $p_1$, $p_2$ the two canonical projections of the product $X \times_S X$;
since $\Delta_f$ is an $X$-section of $X \times_S X$ for both $p_1$ and $p_2$, \emph{each} of these morphisms define, for all $n$, a homomorphism of sheaves of rings $\sh{O}_X \to \sh{P}_{X/S}^n$, right inverse of the augmentation $\sh{P}_{X/S}^n \to \sh{O}_X$ \sref{IV.16.1.7};
we can also say that we thus define on $\sh{P}_{X/S}^n$ \emph{two} \emph{quasi-coherent augmented $\sh{O}_X$-algebra} structures;
the corresponding $\sh{O}_X$-module structures on on $\shGr_n(\sh{P}_{X/S}^n)$ are the same. 
We also have, by passing to the limit, two $\sh{O}_X$-algebra structures on $\sh{P}_{X/S}^\infty$.
\end{env}

\begin{env}[16.3.3]
\label{IV.16.3.3}
The morphism $s = (p_2, p_1)_S: X \times_S X \to X \times_S X$ is an \emph{involutive automorphism} of $X \times_S X$, called the \emph{canonical symmetry}, such that
\[
  \label{IV.16.3.3.1}
  p_1 \circ s = p_2, \qquad p_2 \circ s = p_1, \qquad s \circ \Delta_f = \Delta_f.
  \tag{16.3.3.1}
\]

If we put $s = (\rho, \lambda)$, $p_i = (\pi_i, \mu_i)$ ($i = 1,2$), $\Delta_f = (\delta, \nu)$, $\lambda^\#$ is then an isomorphism of $\rho^*(\pi_1^*(\sh{O}_X))$ onto $\pi_2^*(\sh{O}_X)$, and $\delta^*(\lambda^\#)$ fixes $\delta^*(\sh{O}_{X \times_S X})$ and the kernel $\sh{I}$ of the homomorphism $\nu^\#: \delta^*(\sh{O}_{X \times_S X}) \to \sh{O}_X$.
Therefore:
\end{env}

\begin{proposition}[16.3.4]
\label{IV.16.3.4}
The homomorphism $\sigma = \delta^*(\lambda^\#)$ induced from $s$ (and also called the \emph{canonical symmetry}) is an involutive automorphism of the projective system $(\sh{P}_{X/S}^n)$ of $\sh{O}_X$-augmented 
\oldpage[IV-4]{15}
sheaves of rings, and as a result also of the projective limit $\sh{P}_{X/S}^\infty$.
This automorphism permutes the $\sh{O}_X$-algebra structure on $\sh{P}_{X/S}^n$ and on $\sh{P}_{X/S}^\infty$.
\end{proposition}

\begin{env}[16.3.5]
\label{IV.16.3.5}
In what follows, the two $\sh{O}_X$-algebra structures defined on the $\sh{P}_{X/S}^n$ and on $\sh{P}_{X/S}^\infty$ will play very different roles:
\emph{we will now agree, unless said otherwise, that when $\sh{P}_{X/S}^n$ or $\sh{P}_{X/S}^\infty$ is considered as an $\sh{O}_X$-algebra, it is the algebra structure induced by $p_1$}.
\end{env}

For every open $U$ of $X$ and every section $t \in \Gamma(U, \sh{O}_X)$, we will simply denote by $t.1$ or even $t$ the image of $t$ under the structure morphism $\Gamma(U, \sh{O}_X) \to \Gamma(U, \sh{P}_{X/S}^n)$ (resp. $\Gamma(U, \sh{O}_X) \to \Gamma(U, \sh{P}_{X/S}^\infty)$) (that is to say, the homomorphism corresponding to $p_1$).

\begin{definition}[16.3.6]
\label{IV.16.3.6}
We denote by $d_f^n$, or $d_{X/S}^n$ (resp. $d_f^\infty$, or $d_{X/S}^\infty$), or simply $d^n$ (resp. $d^\infty$), the homomorphism of sheaves of rings $\sh{O}_X \to \sh{P}_{f}^n = \sh{P}_{X/S}^n$ (resp. $\sh{O}_X \to \sh{P}_{f}^\infty = \sh{P}_{X/S}^\infty$) induced by $p_2$.
For every open $U$ of $X$, and every $t \in \Gamma(U, \sh{O}_X)$, $d^n t$ (resp. $d^\infty t$) is called the \emph{principal part of order $n$} (resp. \emph{principal part of infinite order}) of $t$.
We set $dt = d^1 t - t$, and we say that $dt$ is the differential of $t$ (an element of $\Gamma(U, \Omega_{X/S}^1)$, also denoted $d_{X/S}(t)$).
\end{definition}  

It follows immediately
\footnote{
[Trans.] This is, locally we have \sref[0]{0.20.1.1}.
}
from this definition that we have
\[
  \label{IV.16.3.6.1}
  d(t_1 t_2) = t_1 dt_2 + t_2 dt_1
  \tag{16.3.6.1} 
\]
for every $t_1$, $t_2$ in $\Gamma(U \sh{O}_X)$, that is, $d$ is a \emph{derivation} of the ring $\Gamma(U, \sh{O}_X)$ in the $\Gamma(U, \sh{O}_X)$-module $\Gamma(U, \Omega_{X/S}^1)$.

In all notation introduced in \sref{IV.16.3.1} and \sref{IV.16.3.6}, we will sometimes replace $S$ by $A$ when $S = \Spec(A)$.

\begin{env}[16.3.7]
\label{IV.16.3.7}
Suppose in particular that $S = \Spec(A)$ and $X = \Spec(B)$ are affine schemes, $B$ then being an $A$-algebra.
Then $\Delta_f$ correspeonds to the canonical surjective homomorphism $\pi: B \otimes_A B \to B$ such that $\pi(b\otimes b') = bb'$, with kernel $\mathfrak{I} = \mathfrak{I}_{B/A}$ \sref[0]{0.20.4.1};
$\sh{P}_{f}^n$ is the structure sheaf of the prescheme $\Spec(P_{B/A}^n)$, where
\[
  P_{B/A}^n = (B \otimes_A B)/\mathfrak{I}^{n+1};
\]
$\shGr_\bullet(\sh{P}_f)$ is the quasi-coherent $\sh{O}_X$-module corresponding to the graded $B$-module
\[
  \gr_\mathfrak{I}^\bullet(B \otimes_A B) = \bigoplus_{n \geq 0} (\mathfrak{I}^n/\mathfrak{I}^{n+1});
\]
in particular $\Omega_f^1 = \Omega_{X/S}^1$ is the quasi-coherent $\sh{O}_X$-module corresponding to the $B$-module of $1$-differentials of $B$ over $A$, $\Omega_{B/A}^1$ \sref[0]{0.20.4.3}.
The projection morphisms $p_1: X \times_S X \to X$, $p_2: X \times_S X \to X$ corresponding to the two homomorphisms of rings $j_1: B \to B \otimes_A B$, $j_2: B \to B \otimes_A B$ such that $j_1(b) = b \otimes 1$, $j_2(b) = 1 \otimes b$, so that (by the convention of \sref{IV.16.3.5}), $P_{B/A}^n$ is always considered as a $B$-algebra via the composite homomorphism $B \xrightarrow{j_1} B \otimes_A B \to P_{B/A}^n$;
the ring homomorphism $B \xrightarrow{j_2} B \otimes_A B \to P_{B/A}^n$ is denoted by $d_{B/A}^n$ and corresponds to $d_{X/S}^n$ acting on $\Gamma(X, \sh{O}_X)$;
for every $t \in B$, $dt$ is equal to $d_{B/A}t$, defined in \sref[0]{0.20.4.6}.

If $\pi_n: B \otimes_A B \to P_{B/A}^n$ is the canonical homomorphism, so we have, in light of the preceding definitions,
\[
  \label{IV.16.3.7.1}
  \pi_n(b\otimes b') = b \cdot \pi_n(1\otimes b') = b \cdot d_{B/A}^n(b') \quad \text{for } b \in B, b' \in B.
  \tag{16.3.7.1}
\]
\end{env}

\begin{proposition}[16.3.8]
\label{IV.16.3.8}
\oldpage[IV-4]{16}
The image of the canonical homomorphism $d_{X/S}^n: \sh{O}_X \to \sh{P}_{X/S}^n$ generates the $\sh{O}_X$-module $\sh{P}_{X/S}^n$.
\end{proposition}

\begin{proof}
We immediately reduce to the case where $X = \Spec(B)$ and $S = \Spec(A)$ are affine and the proposition follows from \sref{IV.16.3.7.1} since $\pi_n$ is surjective.
We note that in general $d_{X/S}^n$ \emph{is not surjective} (even for $n = 1$).
\end{proof}

\begin{proposition}[16.3.9]
\label{IV.16.3.8}
Suppose that $f:X \to S$ is a morphism locally of finite type.
Then the $\sh{P}_{f}^n$ and the $\shGr_n(\sh{P}_{f})$ are quasi-coherent $\sh{O}_X$-modules of finite type.
\end{proposition}

\begin{proof}
This follows from \sref{IV.16.1.6} and from the fact that $\Delta_f$ is locally of finite presentation \sref[1]{1.4.3.1}.
\end{proof}

\subsection{Functorial properties of differential invariants}
\label{IV.16.4}

\begin{env}[16.4.1]
\label{IV.16.4.1}
Consider a commutative diagram of morphisms of preschemes
\[
  \label{IV.16.4.1.1}
  \xymatrix{
    X \ar[d]_-{f} & X' \ar[l]_-u \ar[d]^-{f'}\\
    S & S' \ar[l]^-w
  }
  \tag{16.4.1.1}
\]
We deduce a commutative diagram
\[
  \xymatrix{
    X \ar[d]_-{\Delta_f} & X' \ar[l]_-u \ar[d]^-{\Delta_{f'}}\\
    X \times_S X & X' \times_{S'} X' \ar[l]^-v
  }
\]
where $v$ is the composite homomorphism \sref[I]{I.5.3.5} and \sref[I]{I.5.3.15}.
\[
  \label{IV.16.4.1.2}
  X' \times_{S'} X' \xrightarrow{(p'_1, p'_2)_S} X' \times_{S} X' \xrightarrow{u \times_S u} X \times_S X.
  \tag{16.4.1.2}
\]

So we induce from $u$ and $v$, as explained in \sref{IV.16.2.1}, homomorphisms of augmented sheaves of rings
\[
  \label{IV.16.4.1.3}
  \nu_n: \rho^*(\sh{P}_{X/S}^n) \to \sh{P}_{X'/S'}^n
  \tag{16.4.1.3}
\]
(where we put $u = (\rho,\lambda)$);
these homomorphisms form a projective system, and therefore give at the limit a homomorphism of sheaves of graded rings
\[
  \label{IV.16.4.1.4}
  \nu_\infty: \rho^*(\sh{P}_{X/S}^\infty) \to \sh{P}_{X'/S'}^\infty;
  \tag{16.4.1.4}
\]
on the other hand, by passing to the quotient, the homomorphisms $\nu_n$ give rise to a di-homomorphism of graded algebras (relative to $\lambda^\#$):
\[
  \label{IV.16.4.1.5}
  \gr(u): \rho^*(\shGr_\bullet(\sh{P}_{X/S})) \to \shGr_\bullet(\sh{P}_{X'/S'}).
  \tag{16.4.1.5}
\]
\end{env}

\begin{env}[16.4.2]
\label{IV.16.4.2}
\oldpage[IV-4]{17}
If we have a commutative diagram
\[
  \xymatrix{
    X \ar[d]_-{f} & X' \ar[l]_-u \ar[d]^-{f'} & X'' \ar[l]_-{u'} \ar[d]^-{f''}\\
    S & S' \ar[l]^-w & S'' \ar[l]^-{w'} 
  }
\]
we deduce a commutative diagram
\[
  \xymatrix{
    X \ar[d]_-{\Delta_f} & X' \ar[l]_-u \ar[d]^-{\Delta_{f'}} & X'' \ar[l]_-{u'} \ar[d]^-{\Delta_{f''}}\\
    X \times_S X & X' \times_{S'} X' \ar[l]^-v & X'' \times_{S''} X'' \ar[l]^-{v'}
  }
\]
where $v'$ is defined from $u'$, $w'$, $f'$, $f''$ as $v$ is from $u$, $w$, $f$, $f'$.
We verify immediately that if $u'' = u \circ u'$, $w'' = w \circ w'$, then the composite homomorphism $v \circ v'$ is equal to the homomorphism $v''$ deduced from $u''$, $v''$, $f$, $f''$ as $v$ is from $u$, $w$, $f$, $f'$.
If we put $u' = (\rho', \lambda')$, $u'' = (\rho'', \lambda'')$ it follows \sref{IV.16.2.1} that the homomorphism $\nu''_n: {\rho''}^*(\sh{P}_{X/S}^n) \to \sh{P}_{X''/S''}^n$ is equal to the composite
\[
  {\rho'}^*(\rho^*(\sh{P}_{X/S}^n)) \xrightarrow{{\rho'}^*(\nu_n^\#)} {\rho'}^*(\sh{P}_{X'/S'}^n) \xrightarrow{\nu'_n} \sh{P}_{X''/S''}^n,
\]
and we have analogous transitivity properties for the homomorphisms \sref{IV.16.4.1.4} and \sref{IV.16.4.1.5}, which lets us say that the $\sh{P}_{X/S}^n$, $\sh{P}_{X/S}^\infty$ and $\shGr_\bullet(\sh{P}_{X/S})$ \emph{depend functorially on $f$}. 
\end{env}

\begin{env}[16.4.3]
\label{IV.16.4.3}
We verify immediately (for example, by restricting ourselves to the affine case with help of \sref{IV.16.3.7}) that with the notation of \sref{IV.16.4.1}, the diagram
\[
  \label{IV.16.4.3.1}
  \xymatrix{
    \rho^*(\sh{O}_X) \ar[r]^-{\lambda^\#} \ar[d] & \sh{O}_{X'} \ar[d] \\
    \rho^*(\sh{P}_{X/S}^n) \ar[r]_-{\nu_n} & \sh{P}_{X'/S'}^n  
  }
  \tag{16.4.3.1}
\]
where the vertical arrows are the ones defining the algebra structure chosen in \sref{IV.16.3.5} (that is to say, the ones coming from the first projections) is commutative;
the same goes for the diagram
\[
  \label{IV.16.4.3.2}
  \xymatrix{
    \rho^*(\sh{O}_X) \ar[r]^-{\lambda^\#} \ar[d]_-{\rho^*(d_{X/S}^n)} & \sh{O}_{X'} \ar[d]^-{d_{X'/S'}^n} \\
    \rho^*(\sh{P}_{X/S}^n) \ar[r]_-{\nu_n} & \sh{P}_{X'/S'}^n  
  }
  \tag{16.4.3.2}
\]
\oldpage[IV-4]{18}
the vertical arrows defining here the algebra structure from the second projection;
besides, if $\sigma$ and $\sigma'$ are the canonical symmetries corresponding to $f$ and $f'$ \sref{IV.16.3.4}, we have
\[
  \nu_n \circ \rho^*(\sigma) = \sigma' \circ \nu_n 
\] 
which switches one diagram with the other.
We deduce from \sref{IV.16.4.3.1} a canonical homomorphism of \emph{augmented $\sh{O}_{X'}$-algebras}
\[
  \label{IV.16.4.3.3}
  P^n(u): u^*(\sh{P}_{X/S}^n) = \sh{P}_{X/S}^n \otimes_{\sh{O}_X} \sh{O}_{X'} \to \sh{P}_{X'/S'}^n 
  \tag{16.4.3.3}
\]
and it follows from \sref{IV.16.4.3.2} that the diagram 
\[
  \label{IV.16.4.3.4}
  \xymatrix{
    \sh{O}_{X'} \ar[r]^-{\operatorname{id}} \ar[d]_-{u^*(d_{X/S}^n)}  & \sh{O}_{X'} \ar[d]^-{d_{X'/S'}^n} \\
    u^*(\sh{P}_{X/S}^n) \ar[r]_{P^n(u)} & \sh{P}_{X'/S'}^n
  }
  \tag{16.4.3.4}
\]
is commutative.
We deduce a homomorphism of \emph{graded $\sh{O}_{X'}$-algebras}
\[
  \label{IV.16.4.3.5}
  \Gr_\bullet(u):u^*(\shGr_\bullet(\sh{P}_{X/S})) \to \shGr_\bullet(\sh{P}_{X'/S'})
  \tag{16.4.3.5}
\]
and in particular a homomorphism of $\sh{O}_{X'}$-modules 
\[
  \label{IV.16.4.3.6}
  \Gr_1(u):\Omega_{X/S}^1 \otimes_{\sh{O}_X} \sh{O}_{X'} \to \Omega_{X'/S'}^1
  \tag{16.4.3.6}
\]
giving rise to a commutative diagram
\[
  \label{IV.16.4.3.7}
  \xymatrix{
    \sh{O}_{X'} \ar[r]^-{\operatorname{id}} \ar[d]_-{d_{X/S} \otimes 1}  & \sh{O}_{X'} \ar[d]^-{d_{X'/S'}} \\
    \Omega_{X/S}^1 \otimes_{\sh{O}_X} \sh{O}_{X'} \ar[r] & \Omega_{X'/S'}^1
  }
  \tag{16.4.3.7}
\]
\end{env}

\begin{env}[16.4.4]
\label{IV.16.4.4}
When $S = \Spec(A)$, $S' = \Spec(A')$, $X = \Spec(B)$, $X' = \Spec(B')$ are affine, so that we have a commutative diagram of ring homomorphisms
\[
  \xymatrix{
    B \ar[r] & B' \\
    A \ar[u] \ar[r] & A' \ar[u]
  }
\]
the image of $\mathfrak{I}_{B/A}$ in $B' \otimes_{A'} B'$ is contained in $\mathfrak{I}_{B'/A'}$, and the homomorphism $\nu_n$ corresponds to the homomorphism of rings $P_{B/A}^n \to P_{B'/A'}^n$ induced from the homomorphism $B \otimes_A B \to B' \otimes_{A'} B'$ by passing to quotients.
The homomorphism \sref{IV.16.4.3.6} corresponds to the homomorphism defined in \sref[0]{0.20.5.4.1}, and the commutative diagram \sref{IV.16.4.3.7} to the diagram \sref[0]{0.20.5.4.2}.
\end{env}

\begin{proposition}[16.4.5]
\label{IV.16.4.5}
\oldpage[IV-4]{19}
Suppose that $X' = X \times_S S'$, $f'$ and $u$ the canonical projections.
Then the canonical homomorphisms $P^n(u)$ \sref{IV.16.4.3.3} and $\Gr_1(u)$ \sref{IV.16.4.3.6} are bijective.
\end{proposition}

\begin{proof}
We have $X' \times_{S'} X' = (X \times_S X) \times_S S'$, and it suffices to apply \sref{IV.16.2.3}[(ii)] replacing $g$ by the first $p_1:X\times_S X \to X$ and $f$ by the diagonal $\Delta_f$.
\end{proof}

We note that under the hypotheses of \sref{IV.16.4.5} the homomorphism $\Gr_\bullet(u)$ \sref{IV.16.4.3.5} is \emph{surjective}, but not bijective in general. 
However \sref{IV.16.2.4}:

\begin{corollary}[16.4.6]
\label{IV.16.4.6}
Under the hypotheses of \sref{IV.16.4.5}, suppose in addition that $w: S \to S'$ is flat (resp. that $\shGr_n(\sh{P}_{X/S}^n)$ are flat $\sh{O}_X$-modules for $n \leq m$);
then the homomorphism
\[
  \Gr_n(u):u^*(\shGr(\sh{P}_{X/S}^n)) \to \shGr(\sh{P}_{X'/S'}^n)
\]
is bijective for each $n$ (resp. for $n \leq m$).
\end{corollary}

\begin{proof}
Indeed, if $w$ is flat, then so is $v: X' \times_{S'} X' \to X \times_S X$, so the conclusion follows from \sref{IV.16.2.4}.
\end{proof}

\begin{env}[16.4.7]
\label{IV.16.4.7}
Let $S$ be a prescheme, $\sh{E}$ a quasi-coherent $\sh{O}_S$-Module, and set $X = \bb{V}(\sh{E})$ \sref[II]{II.1.7.8}, the vector bundle associated to $\sh{E}$, equal to $\Spec(\bb{S}_{\sh{O}_S}(\sh{E}))$.
Let $f:X \to S$ be the structure morphism.
For every open $U$ of $S$ and every section $t \in \Gamma(U, \sh{E})$, $t$ is identified with a section of $\bb{S}_{\sh{O}_S}(\sh{E})$ over $U$;
let $t'$ be its image in $\Gamma(f^{-1}(U), \sh{O}_X) = \Gamma(U, f_*(\sh{O}_X)) = \Gamma(U, \bb{S}_{\sh{O}_S}(\sh{E}))$, and set
\[
  \label{IV.16.4.7.1}
  \delta(t) = d_{X/S}^n(t') - t' \in \Gamma(f^{-1}(U), \sh{P}_{X/S}^n);
  \tag{16.4.7.1}
\]
it is clear that $\delta$ is a di-homomorphism of modules (corresponding to the homomorphism of rings $\Gamma(U, \sh{O}_S) \to \Gamma(f^{-1}(U), \sh{O}_X)$) of $\Gamma(U, \sh{E})$ into $\Gamma(f^{-1}(U), \sh{P}_{X/S}^n)$, and therefore the image belongs to the augmentation ideal of $\Gamma(f^{-1}(U), \sh{P}_{X/S}^n)$.
We deduce (by varying $U$) a canonical homomorphism of $\sh{O}_X$-algebras
\[
  \label{IV.16.4.7.2}
  f^*(\bb{S}_{\sh{O}_S}(\sh{E})) \to \sh{P}_{X/S}^n
  \tag{16.4.7.2}
\]
and in view of the above remark, if $\sh{K}$ is the ideal kernel of augmentation $\bb{S}_{\sh{O}_S}(\sh{E}) \to \sh{O}_S$, the image of $\sh{K}^{n+1}$ by \sref{IV.16.4.7.2} is zero, so that by factoring by $\sh{K}^{n+1}$, we finally have a canonical homomorphism
\[
  \label{IV.16.4.7.3}
  \delta_n: f^*(\bb{S}_{\sh{O}_S}(\sh{E})/\sh{K}^{n+1}) \to \sh{P}_{X/S}^n.
  \tag{16.4.7.3}
\]
\end{env} 

\begin{proposition}[16.4.8]
\label{IV.16.4.8}
Under the conditions of \sref{IV.16.4.7}, the homomorphisms $\delta_n$ are bijective and form a projective system of isomorphisms;
we deduce an isomorphism of graded $\sh{O}_S$-algebras 
\[
  \label{IV.16.4.8.1}
  f^*(\bb{S}_{\sh{O}_S}^\bullet(\sh{E})) \to \shGr_\bullet(\sh{P}_{X/S}).
  \tag{16.4.8.1}
\]
\end{proposition}

\begin{proof}
The fact that homomorphisms \sref{IV.16.4.7.3} form a projective system follows immediately from their definition.
To prove they are isomorphisms, it suffices to 
\oldpage[IV-4]{20}
prove that \sref{IV.16.4.8.1} is an isomorphism, since both filtrations involved in \sref{IV.16.4.7.3} are finite (Bourbaki, \emph{Alg. comm.}, chap.~III, \textsection2, no 8, cor. 3 of th. ~1).
To do this, consider the split exact sequence of $\sh{O}_S$-modules
\[
  \label{IV.16.4.8.2}
  \xymatrix{
    0 \ar[r] & \sh{E} \ar[r]^-u & \sh{E} \oplus \sh{E} \ar[r]^-v & \sh{E} \ar[r] & 0
  }
  \tag{16.4.8.2}
\] 
where, for every pair of sections $s$, $t$ of $\sh{E}$ over an open $U$ of $S$, we take $u(s) = (-s, s)$ and $v(s,t) = s + t$.
We have
\[
  X \times_S X = \Spec(\bb{S}_{\sh{O}_S}(\sh{E}) \otimes_{\sh{O}_S} \bb{S}_{\sh{O}_S}(\sh{E})) = \Spec(\bb{S}_{\sh{O}_S}(\sh{E} \oplus \sh{E}))
\]
(\sref[II]{II.1.4.6} and \sref[II]{II.1.7.11}), and the diagonal morphism $X \to X \times_S X$ corresponds \sref[II]{II.1.2.7} to the homomorphism of $\sh{O}_X$-algebras $\bb{S}(v): \bb{S}_{\sh{O}_S}(\sh{E} \oplus \sh{E}) \to \bb{S}_{\sh{O}_S}(\sh{E})$ \sref[II]{II.1.7.4}, such that if $\sh{I}$ is the kernel of this homomorphism, then we have
\[
  \sh{P}_{X/S}^n = f^*(\bb{S}_{\sh{O}_S}(\sh{E} \oplus \sh{E})/\sh{I}^{n+1}).
\]
The proposition now will be a consequence of the following lemma:
\end{proof}

\begin{lemma}[16.4.8.3]
\label{IV.16.4.8.3}
Let Y be a ringed space, $0 \to \sh{F}'  \xrightarrow{u} \sh{F} \xrightarrow{v} \sh{F}'' \to 0$ an exact sequence of $\sh{O}_Y$ modules such that each point $y \in Y$ has an open neighborhood $V$ such that the sequence $0 \to \sh{F}'|V \to \sh{F}|V \to \sh{F}''|V \to 0$ is split.
Let $\sh{I}$ be the kernel ideal of $\bb{S}(v)$:
\[
  \bb{S}_{\sh{O}_Y}(\sh{F}) \to \bb{S}_{\sh{O}_Y}(\sh{F}''),
\]
and let $\gr_{\sh{I}}^\bullet(\bb{S}_{\sh{O}_Y}(\sh{F}))$ be the graded $\sh{O}_Y$-algebra associated to the $\sh{O}_Y$-algebra $\bb{S}_{\sh{O}_Y}(\sh{F})$ \emph{endowed with the $\sh{I}$-preadic filtration}.
Then the homomorphism of graded $\sh{O}_Y$-algebras
\[
  \label{IV.16.4.8.4}
  \bb{S}_{\sh{O}_Y}^\bullet(\sh{F}') \otimes_{\sh{O}_Y} \bb{S}_{\sh{O}_Y}^\bullet(\sh{F}'') \to \gr_{\sh{I}}^\bullet(\bb{S}_{\sh{O}_Y}(\sh{F}))
  \tag{16.4.8.4}
\]
(where the first member is the graded tensor product of symmetric $\sh{O}_Y$-algebras endowed with the canonical gradation \sref[II]{II.1.7.4} and \sref[II]{II.2.1.2}), induced by the canonical injection
\[
  \sh{F}' \to \sh{I} = \gr_{\sh{I}}^1(\bb{S}_{\sh{O}_Y}(\sh{F})),
\]
is bijective.
\end{lemma}

\begin{proof}
The injection $\sh{F}' \to \sh{I}$ indeed canonically gives a homomorphism of graded $\sh{O}_Y$-algebras $\bb{S}_{\sh{O}_Y}^\bullet(\sh{F}') \to \gr_\sh{I}^\bullet(\bb{S}_{\sh{O}_Y}^\bullet(\sh{F}))$, and since the second member is by definition a graded $\bb{S}_{\sh{O}_Y}^\bullet(\sh{F}'')$-algebra, we induce the canonical homomorphism \sref{IV.16.4.8.4} by tensoring the above with $\bb{S}_{\sh{O}_Y}^\bullet(\sh{F}'')$.
To prove the lemma we can, being a local problem, restrict to the case where $\sh{F} = \sh{F}' \oplus \sh{F}''$, $u$ and $v$ the canonical homomorphisms.
Then the graded algebra $\bb{S}_{\sh{O}_Y}^\bullet(\sh{F})$ is canonically identified with the graded tensor product $\bb{S}_{\sh{O}_Y}^\bullet(\sh{F}') \otimes_{\sh{O}_Y} \bb{S}_{\sh{O}_Y}^\bullet(\sh{F}'')$ \sref[II]{II.1.7.4}, and it is immediate that $\sh{I}$ is therefore the ideal $\sh{I}' \otimes_{\sh{O}_Y} \bb{S}_{\sh{O}_Y}^\bullet(\sh{F}'')$, where $\sh{I}'$ is the augmentation ideal of $\bb{S}_{\sh{O}_Y}^\bullet(\sh{F}')$, that is to say the (direct) sum of the $\bb{S}_{\sh{O}_Y}^m(\sh{F}')$ for $m \geq 1$.
We conclude that $\sh{I}^n = \sh{I}'^n \otimes_{\sh{O}_Y} \bb{S}_{\sh{O}_Y}^\bullet(\sh{F}'')$, where this time $\sh{I}'^n$ is the direct sum of the $\bb{S}_{\sh{O}_Y}^m(\sh{F}')$ for $m \geq n$;
we have therefore $\sh{I}^n/\sh{I}^{n+1} = \bb{S}_{\sh{O}_Y}^n(\sh{F}) \otimes_{\sh{O}_Y} \bb{S}_{\sh{O}_Y}^\bullet(\sh{F}'')$, which proves that \sref{IV.16.4.8.4} is bijective.
\end{proof}

\oldpage[IV-4]{21}
Having proved the lemma, it remains to see that the homomorphism \sref{IV.16.4.8.1} is the image by $f^*$ of the homomorphism \sref{IV.16.4.8.4} corresponding to the exact sequence \sref{IV.16.4.8.2};
we can easily see that it follows from the definition of $u$ \sref{IV.16.4.8.2} and of $\delta$ \sref{IV.16.4.7.1}, given the definition of the $\sh{O}_X$-algebra structures of $\sh{P}_{X/S}^n$ and of the $d_{X/S}^n$ \sref{IV.16.3.5} and \sref{IV.16.4.3.6}.

In particular:

\begin{corollary}[16.4.9]
\label{IV.16.4.9}
Under the conditions of \sref{IV.16.4.7}, we have a canonical isomorphism
\[
\label{IV.16.4.9.1}
  \gr_1(\delta): f^*(\sh{E}) \xrightarrow{\sim} \Omega_{X/S}^1.
  \tag{16.4.9.1}
\]
\end{corollary}

\begin{corollary}[16.4.10]
\label{IV.16.4.10}
If $S = \Spec(A)$, $\sh{E} = \sh{O}_S^m$, so that
\[
  X = \Spec(A[T_1, \dots, T_m]),
\]
then $\sh{P}_{X/S}^n$ is canonically identified with the $\sh{O}_X$-algebra corresponding to the quotient $A[T_1, \dots, T_m]$-algebra\\
$A[T_1, \dots, T_m, U_1, \dots, U_m]/\mathfrak{K}^{n+1}$, where the $U_i$ ($1 \leq i \leq m$) are $m$ new indeterminates and $\mathfrak{K}$ is the ideal generated by $U_1, \dots, U_m$.
\end{corollary}

We thus recover in particular the structure of $\Omega_{X/S}^1$ in this case \sref[0]{0.20.5.13}.

In addition, note that the $d_{X/S}^n$ then corresponds to a polynomial $F(T_1, \dots, T_m)$, the class modulo $\mathfrak{K}^{n+1}$ of $F(T_1 + U_1, \dots, T_m + U_m)$, which follows from the definition \sref{IV.16.4.7.1}.

\begin{proposition}[16.4.11]
\label{IV.16.4.11}  
Let $f:X \to S$ be a morphism, $g: S \to X$ a $S$-section of $X$, $S^{(n)}$ the $n$-th infinitesimal neighborhood of $S$ by the immersion $g$ \sref{IV.16.1.2}.
Then there exists a unique isomorphism of $\sh{O}_S$-algebras
\[
  \label{IV.16.4.11.1}
  \varpi_n: g^*(\sh{P}_{X/S}^n) \to \sh{O}_{S_g^{(n)}}
  \tag{16.4.11.1}
\]  
(via the $\sh{O}_S$-algebra structure on $\sh{O}_{S_g^{(n)}}$ defined by $f$ \sref{IV.16.1.7}), making the diagram
\[
  \label{IV.16.4.11.2}
  \xymatrix{
    \sh{O}_S = g^*(\sh{O}_X) \ar[rr]^-{\lambda_n} \ar[dr]_-{g^*(d_{X/S}^n)} && \sh{O}_{S_g^{(n)}} \\
    & g^*(\sh{P}_{X/S}^n) \ar[ur]_-{\varpi_n}
  }
  \tag{16.4.11.2}
\]
commutative (where $\lambda_n$ is the structure morphism).
\end{proposition} 

\begin{proof}
In light of \sref[I]{I.5.3.7}, where we replace $X$, $Y$, $S$ by $S$, $X$, $S$ respectively and $f$ by $g$, the diagrams
\[
  \label{IV.16.4.11.3}
  \xymatrix@=3pc{
    S \ar[r]^-g \ar[d]_-g &  X \ar[d]^-{\Delta_f} & S \ar[r]^-g  \ar[d]_-g & X \ar[d]^-{\Delta_f}  \\
    X \ar[r]_{(g\circ f, 1_X)_S} & X\times_S X & X \ar[r]_{(1_X, g\circ f)_S} & X \times_S X
  }
  \tag{16.4.11.3}
\]
\oldpage[IV-4]{22}
identifies $S$ with the product of the $(X \times_S X)$-preschemes $X$ and $X$ by the morphisms $\Delta_f$ and $(g\circ f, 1_X)_S$ (resp. $(1_X, g\circ f)_S$).
On the other hand, the diagrams
\[
  \label{IV.16.4.11.4}
  \xymatrix@=3pc{
    X \ar[r]^{(g\circ f, 1_X)_S} \ar[d]_-f &  X \ar[d]^-{p_1} &  X \ar[r]^{(1_X, g\circ f)_S} \ar[d]_-f &  X \ar[d]^-{p_2} \\
    S \ar[r]_{g} & X & S \ar[r]_{g} & X
  }
  \tag{16.4.11.4}
\]
identify $X$ to the product of $X$-preschemes $S$ and $X \times_S X$ via the morphisms $g$ and $p_1$ (resp. $p_2$) (particular case of the associativity formula \sref[I]{I.3.3.9.1}).
We can say that $\Delta_f$, considered as an $X$-section of $X \times_S X$ (relative to $p_1$ or $p_2$) plays the role of a \emph{universal section} for the $S$-sections of $X$:
each of these sections $g$ in fact are deduced by \emph{base change} $(g \circ f, 1_X)_S: X \to X \times_S X$.
The definition of the homomorphism $\bar\omega_n$ and the fact that it is bijective follows from the remarks of \sref{IV.16.2.3}[(ii)] applied to the first diagram \sref{IV.16.4.11.4}.
The commutativity of the first diagram \sref{IV.16.4.11.4} follows also from \sref{IV.16.2.3}[(ii)] this time applied to the second diagram \sref{IV.16.11.4}.
To explain $\varpi_n$, we can restrict ourselves to the case where $g$ is a closed immersion:
Indeed, for every $s\in S$, there is an open neighborhood $W$ of $s$ in $S$ such that $g(W)$ is closed in an open set $U$ of $X$, and it is clear that $g|W$ is a $W$-section of the morphism $U \cap f^{-1}(W)$.
We can then suppose that $S$ is a closed subprescheme of $X$ defined by a quasi-coherent ideal $\sh{K}$.
Then the preceding definitions show that if $W$ is an open of $S$, $t$ is a section of $\sh{O}_X$ over $f^{-1}(W)$, $\varpi_n(d^n t|W)$ is equal to the canonical image of $t$ in $\Gamma(W, (\sh{O}_X/\sh{K}^{n+1})|W)$. 
The uniqueness of $\varpi_n$ then follows since the image of $\sh{O}_X$ under $d_{X/S}^n$ generates the $\sh{O}_X$-module $\sh{P}_{X/S}^n$ \sref{IV.16.3.8}.
\end{proof}

\begin{corollary}[16.4.12]
\label{IV.16.4.12}
Let $k$ be a field, $X$ a $k$-prescheme, $x$ a point of $X$ \emph{rational over $k$}.
Then $(\sh{P}_{X/S}^n)_x \otimes_{\sh{O}_x} \kres(x)$ is canonically isomorphic (as an augmented $\kres(x)$-algebra) to $\sh{O}_x/\mathfrak{m}_x^{n+1}$.
\end{corollary}

\begin{proof}
It suffices to consider the unique $k$-section $g$ of $X$ such that $g(\Spec(k)) = \{x\}$.
\end{proof}

\begin{corollary}[16.4.13]
\label{IV.16.4.13}
Let $f: X \to S$ be a morphism, $s$ a point of $S$, $X_s = X \times_S \Spec(\kres(s))$ the fibre of $f$ in $s$.
If $x \in X_s$ is \emph{rational over $\kres(s)$}, $(\sh{P}_{X/S}^n)_x \otimes_{\sh{O}_s} \kres(s)$ is canonically isomorphic to $\sh{O}_{X_s, x}/{\mathfrak{m}'_x}^{n+1}$, is the maximal ideal of $\sh{O}_{X_s, x}$;
more precisely, this isomorphism sends $(d^n t)_x \otimes 1$ \emph{(where $t$ is a section of $\sh{O}_X$ over an open neighborhood of $x$ in $X$)} to the class of $t_x \otimes 1$ modulo ${\mathfrak{m}'_x}^{n+1}$.
\end{corollary}

\begin{proof}
This follows from \sref{IV.16.4.5} and \sref{IV.16.4.12}.
\end{proof}

The preceding corollaries justify the terminology ``sheaf of principal parts of order $n$''.

\begin{proposition}[16.4.14]
\label{IV.16.4.14}
Let $\rho:A \to B$ be a morphism of rings, $S$ a multiplicative subset of $B$.
Then the canonical homomorphisms 
\[
  \label{IV.16.4.14.1}
  S^{-1}P_{B/A}^n \to P_{S^{-1}B/A}^n
  \tag{16.4.14.1}
\] 
\oldpage[IV-4]{23}
deduced from the canonical homomorphisms $P_{B/A}^n \to P_{S^{-1}B/A}^n$ \sref{IV.16.4.4}, form a projective system and are bijective.
\end{proposition}

\begin{proof}
It suffices to remark that $S^{-1}((B \otimes_A B)/\mathfrak{I}^{n+1}) = S^{-1}(B \otimes_A B)/(S^{-1}\mathfrak{I})^{n+1}$ by flatness, and that $S^{-1}(B \otimes_A B) = (S^{-1}B)\otimes_A (S^{-1}B) $ \sref[I]{I.1.3.4}.
\end{proof}

\begin{corollary}[16.4.15]
\label{IV.16.4.15}
The notation being that of \sref{IV.16.4.14}, let $R$ be a multiplicative subset of $A$ such that $\rho(R) \subset S$.
Then we have canonical isomorphisms 
\[
  \label{IV.16.4.15.1}
  S^{-1}P_{B/A}^n \xrightarrow{\sim} P_{S^{-1}B/R^{-1}A}^n
  \tag{16.4.15.1}
\]
forming a projective system.
\end{corollary}

\begin{proof}
It evidently suffices to define canonical isomorphisms 
\[
  \label{IV.16.4.15.2}
  P_{S^{-1}B/A}^n \xrightarrow{\sim} P_{S^{-1}B/R^{-1}A}^n
  \tag{16.4.15.2}
\]
that is to say that we reduce to the case there $\rho(R)$ is consists of \emph{invertible} elements of $B$.
But then the isomorphism \sref{IV.16.4.15.2} is simply induced by the canonical isomorphism $B \otimes_A B \to B \otimes_{R^{-1}A} B$ by passing to quotients \sref[I]{I.1.5.3}.
\end{proof}

\begin{corollary}[16.4.16]
\label{IV.16.4.16}
Let $f:X \to S$ be a morphism of preschemes, $x$ a point of $X$, $s = f(x)$.
Then we have canonical isomorphisms
\[
  \label{IV.14.4.16.1}
  (\sh{P}_{X/S}^n)_x \xrightarrow{\sim} P_{\sh{O}_x/\sh{O}_s}^n
  \tag{14.4.16.1}
\]
forming a projective system.
\end{corollary}

We deduce from these isomorphisms of the associated graded rings, and in particular a canonical isomorphism
\[
  \label{IV.16.4.16.2}
  (\Omega_{X/S}^1)_x \xrightarrow{\sim} \Omega_{\sh{O}_x/\sh{O}_s}^1.
  \tag{16.4.16.2}
\]

\begin{corollary}[16.4.17]
\label{IV.16.4.17}
Let $k$ be a field, $K$ the field of rational functions $k(T_1, \dots, T_r)$.
Then, for every integer $n$, the homomorphism of $K[U_1, \dots, U_r]$ ($U_i$ indeterminates) into $P_{K/k}^n$ which sends $U_i$ to $d^nT_i - T_i.1$ is surjective and defines an isomorphism from the quotient $K[U_1, \dots, U_n]/\mathfrak{m}^{n+1}$  (where $\mathfrak{m}$ is the ideal generated by the $U_i$) to $P_{K/k}^n$.
\end{corollary}

\begin{proof}
This follows from \sref{IV.16.4.8}, \sref{IV.16.4.10}  and \sref{IV.16.4.14}, where we take $A = k$, $B = k[T_1, \dots, T_r]$ and $S = B \setmin \{0\}$.
\end{proof}

We thus recover the fact that the $dT_i$ form a basis of the $K$-vector space $\Omega_{K/k}^1$ \sref[0]{0.20.5.10}.

\begin{env}[16.4.18]
\label{IV.16.4.18}
Let $f:X \to Y$, $g:Y \to Z$ be two morphisms of preschemes, and consider the canonical homomorphism of augmented $\sh{O}_X$-algebras \sref{IV.16.4.3.3}
\[
  \label{IV.16.4.18.1}
  g_{X/Y/Z}:\sh{P}_{X/Z}^n \to \sh{P}_{X/Y}^n
  \tag{16.4.18.1}
\]
\[
  \label{IV.16.4.18.2}
  f_{X/Y/Z}:f^*(\sh{P}_{Y/Z}^n) \to \sh{P}_{X/Z}^n.
  \tag{16.4.18.2}
\]
Then $g_{X/Y/Z}$ is surjective, and its kernel is the sheaf of ideals generated by the image under $f_{X/Y/Z}$ of the augmentation ideal of $f^*(\sh{P}_{X/Z}^n)$.
\end{env}

\begin{proof}
\oldpage[IV-4]{24}
First note that $g_{X/Y/Z}$ corresponds to the case in \sref{IV.16.4.3.3} where $X' = X$, $S' = Y$ and $S = Z$, $u = 1_X$, and $f_{X/Y/Z}$ to the case where we replace $X', X, S, S'$ by $X, Y, Z, Z$ respectively and $u$, $f$ by $f$, $g$ respectively.

We have a commutative diagram \sref[I]{5.3.5}
\[
  \label{IV.16.4.18.3}
  \xymatrix{
    X \ar[r]^-{\Delta_f} \ar[dr]_-f & X \times_Y X \ar[d]^-p \ar[r]^-j & X \times_Z X \ar[d]^-{f \times_z f} \\
    &   Y \ar[r]_-{\Delta_g}  & Y \times_Z Y
  }
  \tag{16.4.18.3}
\] 
where $j = (1_X, 1_X)_Z$ is an immersion, $j \circ \Delta_f = \Delta_{g \circ f}$, and $p$ is the structure morphism.
Since we can restrict ourselves to the case where $X$, $Y$ and $Z$ are affine, we can suppose that the immersions $\Delta_f$, $\Delta_g$ and $j$ are closed, so that $\sh{O}_X$ and $\sh{O}_{X \times_Y X}$ are identified respectively with $\sh{O}_{X \times_Z X} / \sh{I}$ and $\sh{O}_{X \times_Z X}/\sh{L}$, where $\sh{L} \supset \sh{I}$ are two quasi-coherent ideals corresponding respectively to the immersions $\Delta_{g \circ f} $ and $j$.
The $\sh{O}_X$-algebra $\sh{P}_{X/Z}^n$ is identified with $\sh{O}_{X \times_Z X} / \sh{I}^{n+1}$, and $\sh{P}_{X/Y}^n$ is identified with $\sh{O}_{X \times_Y X}/(\sh{I}/\sh{L})^{n+1}$, which is to say with $\sh{O}_{X \times_Z X}/(\sh{I}^{n+1} + \sh{L})$, and therefore with the quotient of $\sh{P}_{X/Z}^n$ by $(\sh{I}^{n+1} + \sh{L})/\sh{I}^{n+1}$.
But we know (\emph{loc. cit}) that if $p$ and $j$ make $X \times_Y X$ the product of the $(Y \times_Z Y)$-preschemes $Y$ and $X \times_Z X$, so if $\sh{O}_Y$ is identified to $\sh{O}_{Y \times_Z Y}/\sh{K}$, where $\sh{K}$ is the ideal corresponding to $\Delta_g$, $\sh{L}$ is equal to $(f\times_Z f)^*(\sh{K}).\sh{O}_{X \times_Z X}$ \sref[I]{I.4.4.5}.
Since $(\sh{I}^{n+1} + \sh{L})/\sh{I}^{n+1}$ is the ideal of $\sh{P}_{X/Z}^n$ generated by the image of $\sh{L}$, we deduce the proposition.
\end{proof}

\begin{corollary}[16.4.19]
\label{IV.16.4.19}
With the notation of \sref{IV.16.4.18}, we have an exact sequence of quasi-coherent $\sh{O}_X$-modules 
\[
  \label{IV.16.4.19.1}
  \xymatrix{
    f^*(\Omega_{Y/Z}^1) \ar[r]^-{f_{X/Y/Z}} & \Omega_{X/Z}^1 \ar[r]^-{g_{X/Y/Z}} & \Omega_{X/Y}^1 \ar[r] & 0.
  }
  \tag{16.4.19.1}
\]
\end{corollary}

When $X$, $Y$, $Z$ are affine, we recover the exact sequence \sref[0]{20.5.7.1}.

\begin{proposition}[16.4.20]
\label{IV.16.4.20}
Let $f:Y \to Z$ be a morphism, $j: X \to Y$ a closed immersion, $\sh{K}$ the quasi-coherent sheaf of ideals of $\sh{O}_Y$ corresponding to $j$.
It follows that $\sh{P}_{X/Y}^n = \sh{O}_X = \sh{O}_Y/\sh{K}$, the canonical homomorphism $j_{X/Y/Z}: j^*(\sh{P}_{Y/Z}^n) \to \sh{P}_{X/Z}^n$ is surjective, and its kernel is the ideal of $j^*(\sh{P}_{Y/Z}^n)$ generated by $j^*(\sh{O}_Y \cdot d_{Y/Z}^n(\sh{K}))$ (it should be noted that $d_{Y/Z}^n(\sh{K})$ is a subsheaf of abelian groups of $\sh{P}_{X/Z}^n$, but not an $\sh{O}_Y$-module in general).
\end{proposition}

\begin{proof}
We know \sref[I]{I.5.3.8} that the diagonal $\Delta_j:X \to X \times_Y X$ is an isomorphism, from which the first assertion follows.
If $\varpi_1$ and $\varpi_2$ are the two canonical homomorphisms of algebras $\sh{O}_Y \to \sh{P}_{Y/Z}^n$ corresponding respectively to the two canonical projections $p_1$, $p_2$ of $Y \times_Z Y \to Y$, recall that by definition (\sref{IV.16.3.5} and \sref{IV.16.3.6}) $\varpi_1$ is the structure homomorphism of the $\sh{O}_Y$-algebra $\sh{P}_{Y/Z}^n$ and $\varpi_2 = d_{Y/Z}^n$.
The $\sh{O}_X$-algebra $j^*(\sh{P}_{Y/Z}^n)$ is therefore identified with $\sh{P}_{Y/Z}^n/\varpi_1(\sh{K})\sh{P}_{Y/Z}^n$ and its quotient by the ideal generated by $j^*(d_{Y/Z}^n(\sh{K}))$ to $\sh{P}_{Y/Z}^n/(\varpi_1(\sh{K}) + \varpi_2(\sh{K}))\sh{P}_{Y/Z}^n$.
Now note that we have a commutative diagram
\oldpage[IV-4]{25}
\[
  \xymatrix{
  Y \ar[d]_-{\Delta_f} & X \ar[d]^-{\Delta_{f \circ j}} \ar[l]_-{j}  \\
  Y \times_Z Y & X \times_Z X \ar[l]^-{j \times_Z j} 
  }
\]
identifying $X$ with the product of the $(Y \times_Z Y)$-preschemes $Y$ and $X \times_Z X$ \sref[I]{I.5.3.7}.
Since $j \times_Z j$ is an immersion, we therefore deduce from this remark and from \sref{IV.16.2.2} that if $\Delta_{Y/Z}^n$ and $\Delta_{X/Z}^n$ denote the infinitesimal neighborhoods of order $n$ of $Y$ and $X$ by the canonical immersions $\Delta_f$ and $\Delta_{f\circ j}$ respectively, then we have a diagram
\[
  \xymatrix{
  \Delta_{Y/Z}^n \ar[d] & \Delta_{X/Z}^n \ar[d] \ar[l]  \\
  Y \times_Z Y & X \times_Z X \ar[l]^-{j \times_Z j} 
  }
\]
making $\Delta_{X/Z}^n$ the product of the $(Y \times_Z Y)$-preschemes $\Delta_{Y/Z}^n$ and $X \times_Z X$.
We can also say that $\sh{P}_{X/Z}^n$ is identified with the sheaf of rings $\sh{P}_{Y/Z}^n \otimes_{\sh{O}_{Y \times_Z Y}} \sh{O}_{X \times_Z X}$.
But we see immediately that (for example, by restricting to the affine case) that $\sh{O}_{X \times_Z X} = \sh{O}_{Y \times_Z Y}/(p_1^*(\sh{K}) + p_2^*(\sh{K}))\sh{O}_{Y \times_Z Y}$.
Therefore $\sh{P}_{X/Z}^n$ is identified with the quotient of $\sh{P}_{Y/Z}^n$ by the ideal generated by the image in $\sh{P}_{Y/Z}^n$ of $p_1^*(\sh{K}) + p_2^*(\sh{K})$.
But by definition this ideal is generated by $\varpi_1(\sh{K}) + \varpi_2(\sh{K})$. 
\end{proof}

\begin{corollary}[16.4.21]
\label{IV.16.4.21}
Let $f:Y \to Z$ be a morphism, $j: X \to Y$ an immersion.
We have an exact sequence of quasi-coherent $\sh{O}_X$-modules
\[
  \label{IV.16.4.21.1}
  \xymatrix{
    \sh{N}_{X/Y} \ar[r] & j^*(\Omega_{Y/Z}^1) \ar[r] & \Omega_{X/Z}^1 \ar[r] & 0.
  }
  \tag{16.4.21.1}
\]
\end{corollary}

When $X$, $Y$, $Z$ are affine, we recover the exact sequence \sref[0]{0.20.5.12.1}.

\begin{corollary}[16.4.22]
\label{IV.16.4.22}
If $f: X \to S$ is a morphism locally of finite presentation, $\sh{P}_{X/S}^n$ and $\Omega_{X/S}^1$ are quasi-coherent $\sh{O}_X$-modules of finite presentation.
\end{corollary}

\begin{proof}
We immediately reduce to the case where $S = \Spec(A)$ is affine, $X = \Spec(B)$, where $B = A[T_1, \dots, T_r]/\mathfrak{K}$, $\mathfrak{K}$ being an ideal of finite type of $C = A[T_1, \dots, T_r]$.
Applying \sref{IV.16.4.20} where $Z = S$, $Y = \Spec(C)$ and $\sh{K} = \widetilde{\mathfrak{K}}$.
Then $j^*(\sh{P}_{Y/Z}^n)$ is a free $\sh{O}_X$-module of finite rank \sref{IV.16.4.10} and the hypothesis on $\mathfrak{K}$ implies that $j^*(\sh{O}_Y.d_{Y/Z}^n(\sh{K}))$ generates a quasi-coherent $\sh{O}_X$-module of finite type;
hence the conclusion.
\end{proof}

\begin{proposition}[16.4.23]
\label{IV.16.4.23}
Let $X$, $Y$ be two $S$-preschemes, $Z = X \times_S Y$ their product, $p:X \times_S Y \to X$ and $q:X \times_S Y \to Y$ the canonical projections.
Then the canonical homomorphism
\[
  \label{IV.16.4.23.1}
  p_{Z/X/S} \oplus q_{Z/Y/S}: p^*(\Omega_{X/S}^1) \oplus  q^*(\Omega_{Y/S}^1) \to \Omega_{(X\times_S Y)/S}^1
  \tag{16.4.23.1}
\]
is bijective.
\end{proposition}   

\begin{proof}
\oldpage[IV-4]{26}
The commutative diagram
\[
  \xymatrix{
    Y \ar[d]_-g & X \times_S Y \ar[l]_-q \ar[d]_-h & X \times_S Y \ar[l]_-{\operatorname{id}} \ar[d]^-p\\
    S & S \ar[l]^-{\operatorname{id}} & X \ar[l]^-f
  }
\]
gives us a factorization of the canonical \emph{isomorphism} $P^n(p)$ \sref{IV.16.4.5}
\[
  p^*(\sh{P}_{X/S}^n) \to \sh{P}_{Z/S}^n \to \sh{P}_{Z/Y}^n
\]
and similarly, switching $X$ with $Y$, we have a factorization of the \emph{isomorphism} $P^n(q)$
\[
  q^*(\sh{P}_{Y/S}^n) \to \sh{P}_{Z/S}^n \to \sh{P}_{Z/Y}^n.
\]
This proves that the canonical homomorphism \sref{IV.16.4.18.1}
\[
  p_{Z/X/S}:p^*(\sh{P}_{X/S}^n) \to \sh{P}_{Z/S}^n \quad \text{(resp. $q_{Z/X/S}:q^*(\sh{P}_{Y/S}^n) \to \sh{P}_{Z/S}^n$)}
\] 
is \emph{injective}, and that the kernel of the canonical surjective homomorphism  \sref{IV.16.4.18.2}
\[
  \sh{P}_{Z/S}^n \to \sh{P}_{Z/Y}^n \quad \text{(resp. $\sh{P}_{Z/S}^n \to \sh{P}_{Z/X}^n$)}
\] 
is direct summand of the image $p_{Z/X/S}$ (resp. $q_{Z/Y/S}$).
On the other hand, this kernel is, by virtue of \sref{IV.16.4.18}, generated by the image by $q_{Z/Y/S}$ (resp. $p_{Z/X/S}$) of the augmentation ideal of $q^*(\sh{P}_{Y/S}^n)$ (resp. $p^*(\sh{P}_{X/S}^n)$).
We conclude the proposition by considering the case $n = 1$.
\end{proof}

We immediately generalize \sref{IV.16.4.23} to the case of a product of any finite number of $S$-preschemes.

\begin{remarks}[16.4.24]
\label{IV.16.4.24}
\medskip\noindent
\begin{enumerate}
  \item[(i)] We will see \sref{IV.17.2.3} that when the morphism $f: X \to Y$ in \sref{IV.16.4.18} is \emph{smooth}, the homomorphism $f_{X/Y/Z}$ in \sref{IV.16.4.19.1} is locally \emph{left invertible} and in particular injective.
  Similarly, when the morphism $f \circ j: X \to Z$ of \sref{IV.16.4.20} is \emph{smooth}, the homomorphism on the left in \sref{IV.16.4.21.1} is locally \emph{left invertible} and \textit{a fortiori} injective \sref{IV.17.2.5}.
  In Chapter~V, we will also give a variant, in the case of modules over a prescheme, of the ``imperfection modules'' studied in \sref[0]{0.20.6}, and the exact sequences where they occur.
  \item[(ii)] Let $X$ be a topological space, $\sh{A}$ a sheaf of  rings over $X$ and $\sh{B}$ a $\sh{A}$-algebra over $X$.
  Then it is clear that 
  \[
    U \mapsto P_{\Gamma(U, \sh{B})/\Gamma(U, \sh{A})}^n \quad \text{($U$ open in $X$)}
  \]
  is a presheaf of augmented $\Gamma(U, \sh{B})$-algebras, and therefore the associated sheaf $\sh{P}_{\sh{B}/\sh{A}}^n$ is an augmented $\sh{B}$-algebra.
  In the particular case where $X$ is a prescheme, $f = (\psi, \theta): X \to S$ a morphism of preschemes, it follows easily from \sref{IV.16.4.16} and from the exactness of the functor $\varinjlim$ that $\sh{P}_{X/S}^n$ is canonically isomorphic to $\sh{P}_{\sh{O}_X/\psi^*(\sh{O}_S)}^n$.
  It follows that the formalism developed in the present paragraph could be considered as a
\oldpage[IV-4]{27}
  particular case of a differential formalism for ringed spaces endowed with a sheaf of algebras over the structure sheaf.
  However, we did not start with this point of view, which is less intuitive and less convenient for applications.
  It also seems that, for various kinds of ``varieties'', the ``global'' constructions of the $\sh{P}^n$ analogous to those we have used here are also better suited for applications.
\end{enumerate}
\end{remarks}

\subsection{Relative tangent sheaves and bundles; derivations.}
\label{IV.16.5}

\begin{env}[16.5.1]
\label{IV.16.5.1}
Let $f = (\psi, \theta):X \to S$ be a morphism of ringed spaces.
For every $\sh{O}_X$-module $\sh{F}$, we call $S$-\emph{derivation} (or $(X/S)$-derivation, or $f$-derivation) of $\sh{O}_X$ to $\sh{F}$ every homomorphism of \emph{sheaves of additive groups} $D: \sh{O}_X \to \sh{F}$, verifying the following conditions:
\begin{enumerate}
  \item[\rm{(a)}] for every open set $V$ of $X$, and all pair of sections $(t_1, t_2)$ of $\sh{O}_X$ over $V$, we have
  \[
    \label{IV.16.5.1.1}
    D(t_1t_2) = t_1D(t_2) + D(t_1)t_2;
    \tag{16.5.1.1}
  \]
  \item[\rm{(b)}] for every open set $V$ of $X$, every section $t$ of $\sh{O}_X$ over $V$ and every section $s$ of $\sh{O}_S$ over an open set $U$ of $S$ such that $V \subset f^{-1}(U)$, we have
  \[
    \label{IV.16.5.1.2}
    D((s|V)t) = (s|V)D(t).
    \tag{16.5.1.2}
  \]
\end{enumerate}
It is clear that this amounts to saying that, for all $x \in X$, the homomorphism of additive groups $D_x:\sh{O}_x \to \sh{F}_x$ is an $\sh{O}_{f(x)}$-derivation.

Another interpretation consists in considering the $\sh{O}_X$-algebra $\sh{D}_{\sh{O}_X}(\sh{F})$ equal to $\sh{O}_X \oplus \sh{F}$, the algebra structure being defined by the condition that for every open set $V$ of $X$, the product of two sections of $\sh{O}_X$ (resp. of a section of $\sh{O}_X$ and a section of $\sh{F}$) over $V$ is defined by the ring structure of $\Gamma(V, \sh{O}_X)$ (resp. the $\Gamma(V, \sh{O}_X)$-module structure on $\Gamma(V, \sh{F})$), and the product of two sections of $\sh{F}$ over $V$ is chosen to be zero;
then $\sh{F}$ is an ideal of $\sh{D}_{\sh{O}_X}(\sh{F})$, kernel of the canonical augmentation $\sh{D}_{\sh{O}_X}(\sh{F}) \to \sh{O}_X$, and to say that $D$ is an $S$-derivation of $\sh{O}_X$ in $\sh{F}$ means that $1_{\sh{O}_X} + D$ is an $\sh{O}_S$-homomorphism of algebras from $\sh{O}_X$ into $\sh{D}_{\sh{O}_X}(\sh{F})$, which, composed with the augmentation, gives $1_{\sh{O}_X}$.

The $S$-derivations of $\sh{O}_X$ in $\sh{F}$ clearly form a $\Gamma(X, \sh{O}_X)$-module $\Der_{\sh{O}_S}(\sh{O}_X, \sh{F})$.

When $\sh{F} = \sh{O}_X$, an $S$-derivation of $\sh{O}_X$ to itself is simply called an $S$-derivation of $\sh{O}_X$.
\end{env}

\begin{proposition}[16.5.2]
\label{IV.16.5.2}
Let $A$ be a ring, $B$ an $A$-algebra, $L$ a $B$-module;
let $S = \Spec(A)$, $X=\Spec(B)$, $\sh{F} = \widetilde{L}$.
Then the mapping $D \mapsto \Gamma(D)$ which, to every $S$-derivation $D$ of $\sh{O}_X$ to $\sh{F}$ gives us the mapping $\Gamma(D): t \mapsto D(t)$ of $B$ to $L$, is an isomorphism of $B$-modules of $\Der_S(\sh{O}_X, \sh{F})$ onto $\Der_A(B, L)$ (cf. \sref[0]{0.20.1.2}).
\end{proposition}

\begin{proof}
This follows immediately from the given interpretation of $S$-derivations in terms
\oldpage[IV-4]{28}
of homomorphisms of algebras, analogous to the interpretation given in \sref[0]{0.20.1.6}, and of the canonical correspondence between homomorphisms of $\sh{O}_X$-algebras and homomorphisms of $B$-algebras ( \sref[I]{I.1.3.13} and  \sref[I]{I.1.3.8}).
\end{proof}

\begin{proposition}[16.5.3]
\label{IV.16.5.3}
Let $f = (\psi, \theta): X \to S$ be a morphism of preschemes.
\begin{enumerate}
  \item[\rm{(i)}] The differential $d_{X/S}:\sh{O}_X \to \Omega_{X/S}^1$ \sref{IV.16.3.6} is an $S$-derivation.
  \item[\rm{(ii)}] For every $\sh{O}_X$-module $\sh{F}$, the mapping $u \mapsto u \circ d_{X/S}$ is an isomorphism of $\Gamma(X, \sh{O}_X)$-modules
  \[
    \label{IV.16.5.3.1}
    \Hom_{\sh{O}_X}(\Omega_{X/S}^1, \sh{F}) \xrightarrow\sim \Der_S(\sh{O}_X, \sh{F}).
    \tag{16.5.3.1}
  \]
\end{enumerate}
\end{proposition}

\begin{proof}
The assertion \rm{(i)} has already been noted \sref{IV.16.3.6}.
On the other hand, it is immediate (in light of \sref[0]{0.20.4.8}) that $u \mapsto u\circ d_{X/S}$ is injective, considering considering the restrictions to a fiber $\sh{O}_x$ of the two members and \sref{IV.16.4.16.2}.
To see that the homomorphism \sref{IV.16.5.3.1} is surjective, consider an $S$-derivation $D: \sh{O}_X \to \sh{F}$;
for every affine open $V = \Spec(B) $ of $X$, such that $f(V)$ is contained in  an affine open $U = \Spec (A)$ of $S$, $D_V:B \to \Gamma(V, \sh{F}) $ is an $A$-derivation, and therefore there exists a \emph{unique} $B$-homomorphism $u_V:\Omega_{B/A}^1 \to \Gamma(V, \sh{F})$ such that $D_V = u_V \circ d_{B/A}$ \sref[0]{0.20.4.8};
also, the uniqueness of the $u_V$ shows immediately that for an affine open $W \subset V$ we have $u_W = u_V|W$, and therefore the $u_V$ define a homomorphism of $\sh{O}_X$-modules $u:\sh{O}_X \to \sh{F}$ answering the question.
\end{proof}

\begin{env}[16.5.4]
\label{IV.16.5.4}
With the notations of \sref{IV.16.5.1}, for every open set $U$ of $X$, $\Der_S(\sh{O}_U, \sh{F}|U)$ is a $\Gamma(U, \sh{O}_X)$-module and it is cleat that the application $U \mapsto \Der_S(\sh{O}_U, \sh{F}|U)$ is a presheaf;
in fact, it is even a \emph{sheaf} (and therefore an $\sh{O}_X$-module), in light of the pointwise characterization of $S$-derivations, seen in \sref{IV.16.5.1}.
This $\sh{O}_X$-module is denoted by $\shDer_S(\sh{O}_X, \sh{F})$ and is called the \emph{sheaf of $S$-derivations of $\sh{O}_X$ in $\sh{F}$}, and what we've come to see is further expressed in the following corollary:
\end{env}

\begin{corollary}[16.5.5]
\label{IV.16.5.5}
For every $\sh{O}_X$-module $\sh{F}$, the homomorphism of $\sh{O}_X$-modules deduced from $d\mapsto u \circ d_{X/S}$
\[
  \label{IV.16.5.5.1}
  \shHom_{\sh{O}_X}(\Omega_{X/S}^1, \sh{F}) \to \shDer_S(\sh{O}_X, \sh{F})
  \tag{16.5.5.1}
\]
is bijective.
\end{corollary}


\begin{corollary}[16.5.6]
\label{IV.16.5.6}
\begin{enumerate}
  \item[(i)] If the morphism $f:X \to S$ is locally of finite presentation and if $\sh{F}$ is a quasi-coherent $\sh{O}_X$-module, then $\shDer_S(\sh{O}_X, \sh{F})$ is a quasi-coherent $\sh{O}_X$-module.
  \item[(ii)] If $S$ is also locally Noetherian and if $\sh{F}$ is quasi-coherent, then $\shDer_S(\sh{O}_X, \sh{F})$ is a coherent $\sh{O}_X$-module.
\end{enumerate}
\end{corollary}

\begin{proof}
The assertion (i) follows from the isomorphism \sref{IV.16.5.5.1}, from \sref{IV.16.4.22} and \sref[I]{I.3.12};
the assertion (ii) follows from \sref[0]{0.5.3.5}.
\end{proof}

\begin{env}[16.5.7]
\label{IV.16.5.7}
We put
\[
  \label{IV.16.5.7.1}
  \mathfrak{G}_{X/S} = \shHom_{\sh{O}_X}(\Omega_{X/S}^1, \sh{O}_X) = \shDer_S(\sh{O}_X, \sh{O}_X)
  \tag{16.5.7.1}  
\]
and say that it is the \emph{sheaf of $S$-derivations of $\sh{O}_X$}, or even the \emph{tangent sheaf of $X$ relative to $S$}:
it is therefore the dual of the $\sh{O}_X$-module $\Omega_{X/S}^1$.
If $f$ is locally of finite
\oldpage[IV-4]{29}
presentation, $\mathfrak{G}_{X/S}$ is a quasi-coherent $\sh{O}_X$-module; if also $S$ is locally Noetherian, $\mathfrak{G}_{X/S}$ is coherent \sref{IV.16.5.6}.
\end{env}

\begin{env}[16.5.8]
\label{IV.16.5.8}
Suppose in particular that $\Omega_{X/S}^1$ is a \emph{locally free} $\sh{O}_X$-module (of finite rank) (which will be the case then $f$ is smooth \sref{IV.17.2.3});
then $\mathfrak{G}_{X/S}$ is locally free $\sh{O}_X$-module of same rank as $\Omega_{X/S}^1$ at each point.
More specifically, suppose that $\Omega_{X/S}^1$ is of rank $n$ at a point $x$;
then there are $n$ sections $s_i$ ($1 \leq i \leq n$) of $\sh{O}_X$ over an affine neighborhood $U$ of $x$ such that the canonical images of the $ds_i$ in $\Omega_{X/S}^1 \otimes \kres(x)$ form a basis if this $\kres(x)$-vector space;
in virtue of Nakayama's lemma, the germs $(ds_i)_x = d(s_i)_x$ of the $ds_i$ at the point $x$ form a basis of the $\sh{O}_x$-module $(\Omega_{X/S}^1)_x$, and therefore, restricting $U$, we can suppose that the $ds_i$ form a \emph{basis} of the $\Gamma(U, \sh{O}_X)$-module $\Gamma(U, \Omega_{X/S}^1)$.
So the $\Gamma(U, \sh{O}_X)$-module $\Gamma(U, \mathfrak{G}_{X/S})$ is dual to the above;
and we denote $(D_i)_{1 \leq i \leq n}$ or $(\frac{\partial}{\partial s_i})_{1 \leq i \leq n}$ the dual basis of $(ds_i)_{1 \leq i \leq n}$, so that, by \sref{IV.16.5.3}, we have
\[
  \label{IV.16.5.8.1}
  D_i s_j = \langle D_i, ds_j \rangle = \langle \frac{\partial}{\partial s_i}, ds_j \rangle = \delta_{ij} \quad \text{(Kronecker's symbol)}.
  \tag{16.5.8.1}
\]
Every $\Gamma(S, \sh{O}_S)$-derivation of the $\Gamma(S, \sh{O}_S)$-algebra $\Gamma(U, \sh{O}_X)$ is written in an unique way as 
\[
  D = \sum_{i = 1}^n a_i D_i = \sum_{i = 1}^n a_i \frac{\partial}{\partial s_i}
\] 
where the $a_i$ ($1 \leq i \leq n$) are sections of $\sh{O}_X$ over $U$.
For every section $g \in \Gamma(U, \sh{O}_X)$, if we put $dg = \sum_{i = 1}^n c_i ds_i$, we have $c_i = \langle D_i, dg \rangle = D_i g$ in virtue of \sref{IV.16.5.8.1}, in other words
\[
  \label{IV.16.5.8.2}
  dg = \sum_{i = 1}^n (D_i g) ds_i = \sum_{i = 1}^n \frac{\partial g}{\partial s_i} ds_i.
  \tag{16.5.8.2}
\]
\end{env}

\begin{env}[16.5.9]
\label{IV.16.5.9}
Let $D_1$, $D_2$ be two $S$-derivations of $\sh{O}_X$. 
For every open set $U$ of $X$, if $D_1^U$, $D_2^U$ are the corresponding derivations on the ring $\Gamma(U, \sh{O}_X)$, the \emph{bracket}
\[
  [D_1^U, D_2^U] = D_1^U \circ D_2^U - D_2^U \circ D_1^U
\]
is a derivation in this ring, and therefore the $\psi^*(\sh{O}_S)$-endomorphism of $\sh{O}_X$
\[
  \label{IV.16.5.9.1}
  [D_1, D_2] = D_1 \circ D_2 - D_2 \circ D_1
  \tag{16.5.9.1}
\]
is also an $S$-derivation;
since one verifies immediately the Jacobi identity, we have thus defined on $\Der_S(\sh{O}_X, \sh{O}_X)$ a \emph{$\Gamma(S, \sh{O}_S)$-Lie algebra} structure.
Since the definition of this structure commutes with the restriction to an open set of $X$, we thus see that $\mathfrak{G}_{X/S}$ is canonically endowed with a \emph{ $\psi^*(\sh{O}_S)$-Lie algebra} structure.
Note that the mapping $(D_1, D_2) \mapsto [D_1, D_2]$ is \emph{not $\Gamma(X, \sh{O}_X)$-bilinear}.
\end{env} 

\begin{env}[16.5.10]
\label{IV.16.5.10}
For every base change $g:S' \to S$, putting $X' = X \times_S S'$, we see \sref{IV.16.4.5} that we have a canonical isomorphism
\[
  \label{IV.16.5.10.1}
  \Omega_{X/S}^1 \otimes_S S' \xrightarrow{\sim} \Omega_{X'/S'}^1
  \tag{16.5.10.1}
\]
\oldpage[IV-4]{30}  
from where we deduce, by \sref{IV.16.5.10.1}, a canonical homomorphism (Bourbaki, \emph{Alg.}, chap.~II, 3rd ed. , \textsection5, no 3)
\[
  \label{IV.16.5.10.2}
  \mathfrak{G}_{X/S} \otimes_{\sh{O}_S} \sh{O}_{S'} \to \mathfrak{G}_{X'/S'} 
  \tag{16.5.10.2}
\]
which is neither injective nor surjective in general.
However:
\end{env}

\begin{proposition}[16.5.11]
\label{IV.16.5.11}
\begin{enumerate}
  \item[\rm{(i)}] If $g:S' \to S$ is a flat morphism and if $f$ is locally of finite type (resp. locally of finite presentation), the homomorphism \sref{IV.16.5.10.2} is injective (resp. bijective).
  \item[\rm{(ii)}] If $\Omega_{X/S}^1$ is a locally free $\sh{O}_X$-module of finite rank, the homomorphism \sref{IV.16.5.10.2} is bijective.
\end{enumerate}
\end{proposition}

\begin{proof}
Indeed, the assertion \rm{(ii)} follows from Bourbaki, \emph{Alg.}, chap.~II, 3rd ed. , \textsection5, no 3, prop. 7.
The assertion \rm(i) follows similarly from Bourbaki, \emph{Alg. Comm.}, chap.~I, \textsection2, no 10, prop. 11 and of the fact that if $f$ is locally of finite type (resp. locally of finite presentation) $\Omega_{X/S}^1$ is a finite type (resp. finite presentation) $\sh{O}_X$-module \sref{IV.16.3.9} \sref{IV.16.4.22}. 
\end{proof}

\begin{env}[16.5.12]
\label{IV.16.5.12}
Since $\Omega_{X/S}^1$ is a quasi-coherent $\sh{O}_X$-module, we can consider the vector bundle over $X$ defined by $\Omega_{X/S}^1$ \sref[II]{II.1.7.8}
\[
  \label{IV.16.5.12.1}
  T_{X/S} = \bb{V}(\Omega_{X/S}^1)
  \tag{16.5.12.1}
\]
which is called the \emph{tangent bundle of $X$ relative to $S$}.
We have therefore a canonical bijection \sref[II]{II.1.7.9}
\[
  \Gamma(T_{X/S}/S) \xrightarrow{\sim} \Hom_{\sh{O}_X}(\Omega_{X/S}^1, \sh{O}_X) = \Gamma(X, \mathfrak{G}_{X/S})
\]
by definition of $\mathfrak{G}_{X/S}$, and we can replace $X$ by an open set $U$ of $X$ in this isomorphism;
so we can say that the \emph{tangent sheaf} of $X$ relative to $S$ is isomorphic to the \emph{sheaf of germs of $S$-sections} of the tangent bundle of $X$ relative to $S$.
If $f:X \to Y$ is an $S$-morphism, we saw \sref{IV.16.4.19} that we have a canonical homomorphism $f_{X/Y/S}:f^*(\Omega_{Y/S}^1) \to \Omega_{X/S}^1$, which, having in mind that
\[
  \bb{V}(f^*(\Omega_{Y/S}^1)) = \bb{V}(\Omega_{Y/S}^1) \times_Y X \quad \text{\sref[II]{II.1.7.11} },
\]
gives us an $X$-morphism $T_{X/S}(f): T_{X/S} \to T_{Y/S} \times_Y X$.
If $g:Y \to Z$ is a second $S$-morphism, we have $T_{X/S}(g \circ f) = (T_{Y/S}(g) \times 1_X ) \circ T_{X/S}(f)$ \sref[0]{0.20.5.4.1}.

It follows from \sref{IV.16.5.10.1} and from \sref[II]{II.1.7.11} that for every base change $g:S' \to S$ we have a canonical morphism
\[
  \label{IV.16.5.12.2}
  T_{X'/S'} \xrightarrow{\sim} T_{X/S} \times_S S' = T_{X/S} \times_X X'.
  \tag{16.5.12.2}
\]
\end{env}

\begin{env}[16.5.13]
\label{IV.16.5.13}
For every point $x \in X$, we define the \emph{tangent space of $X$ at the point $x$} (relative to $S$) to be the set of points in the fiber $T_{X/S} \times_X \Spec(\kres(x))$ that are \emph{rational over $\kres(x)$}, that is the set
\[
  \label{IV.16.5.13.1}
  T_{X/S}(x) = \Hom_{\kres(x)}(\Omega_{X/S}^1 \otimes_{\sh{O}_x} \kres(x), \kres(x))
  \tag{16.5.13.1}
\]
which is the dual of the $\kres(x)$-vector space $\Omega_{\sh{O}_x/\sh{O}_s}^1/\mathfrak{m}_x.\Omega_{\sh{O}_x/\sh{O}_s}^1$.
When $\Omega_{X/S}^1$ is a finite type $\sh{O}_X$-module, then $T_{X/S}$ is a vector space of finite rank over $\kres(x)$, and for every base change
\oldpage[IV-4]{31}
$g:S \to S'$, and every $x' \in X' = X \times_S S'$ over $x$, we have a canonical isomorphism
\[
  \label{IV.16.5.13.2}
  T_{X'/S'}(x') \xrightarrow\sim T_{X/S} \otimes_{\kres(x)} \kres(x').
  \tag{16.5.13.2}
\]
If $x$ is \emph{rational} over $\kres(s)$, where $s = f(x)$ (so that $\kres(s) \to \kres(x)$ is an isomorphism), it follows from \sref{IV.16.4.13} that we have a canonical isomorphism
\[
  \label{IV.16.5.13.3}
  T_{X/S}(x) = T_{X_s/\kres(s)}(x) = \Hom_{\kres(s)}(\mathfrak{m}'_x/\mathfrak{m}_x^{'2}, \kres(x))
  \tag{16.5.13.3}
\]
where $\mathfrak{m}'_x$ is the maximal ideal of $\sh{O}_{X_s,x} = \sh{O}_{X, x}/\mathfrak{m}_s \sh{O}_{X,x}$.
When $S$ is the spectrum of a field $k$, we recover the definition of Zariski tangent space of a point $x \in X$ \emph{rational over $k$} as the dual of $\mathfrak{m}_x / \mathfrak{m}_x^2$.

Let $Y$ be a second $S$-prescheme and let $g:Y \to X$ be an $S$-morphism;
then we have a canonical morphism of $\sh{O}_Y$-modules \sref{IV.16.4.19}
\[
  \label{IV.16.5.13.4}
  g_{Y/X/S}: g^*(\Omega_{X/S}^1) \to \Omega_{Y/S}^1.
  \tag{16.5.13.4}
\]
Now note that if $y \in Y$ and $x = g(y)$, we have
\[
  g^*(\Omega_{X/S}^1) \otimes_{\sh{O}_Y} \kres(y) = (\Omega_{X/S}^1 \otimes_{\sh{O}_X} \kres(x)) \otimes_{\sh{O}_Y} \kres(y) 
\]
and consequently, if $\Omega_{X/S}^1$ is a finite type $\sh{O}_X$-module, we can identify
\[
  \Hom_{\kres(y)}(g^*(\Omega_{X/S}^1) \otimes_{\sh{O}_Y} \kres(y), \kres(y))
\]
to $T_{X/S}(x) \otimes_{\kres(x)} \kres(y)$.
We therefore deduce from the homomorphism \sref{IV.16.5.13.4} a homomorphism of $\kres(y)$-vector spaces
\[
  \label{IV.16.5.13.5}
  T_y(g): T_{Y/S}(y) \to T_{X/S}(x) \otimes_{\kres(x)} \kres(y)
  \tag{16.5.13.5}
\]
called the \emph{linear mapping tangent to $g$ at the point $y$}.
When $y$ is \emph{rational over $\kres(s)$}, we can identify $\kres(s)$, $\kres(y)$ and $\kres(x)$, and $T_y(g)$ is then a homomorphism of $\kres(s)$-vector spaces $T_{Y/S} \to T_{X/S}(x)$;
also note in this case, $g^*(\Omega_{X/S}^1) \otimes_{\sh{O}_Y} \kres(y)$ is identified with $\Omega_{X/S}^1 \otimes_{\sh{O}_X} \kres(x)$, and the above homomorphism is therefore defined without any conditions of finiteness on $\Omega_{X/S}^1$ and it is exactly the homomorphism \sref{IV.16.5.12} restricted to the fiber of $T_{Y/S}$ at $y$.
\end{env}

\begin{env}[16.5.14]
\label{IV.16.5.14}
The interpretation of derivations of an $A$-algebra $B$ to a $B$-module $L$, given in \sref[0]{0.20.1.1}, translates to the language of preschemes in the following way.

Consider two morphisms of preschemes $f: X \to S$, $g: Y \to S$, and a closed subprescheme $Y_0$ of $Y$ defined by a \emph{zero-square} ideal $\sh{I}$ of $\sh{O}_Y$ (so that $Y$ and $Y_0$ have the same underlying subspace).
Suppose we are given an $S$-morphism $u_0:Y_0 \to X$, so that we have a commutative diagram
\[
  \label{IV.16.5.14.1}
  \xymatrix{
    X \ar[d]_-f & Y_0 \ar[l]_-{u_0}\ar[d]^j \\
    S & Y \ar@{-->}[ul]_-u \ar[l]^-g
  }
  \tag{16.5.14.1}
\]
\oldpage[IV-4]{32}
and lets search for an \emph{$S$-morphism} $u:Y \to X$ such that $u_0 = u \circ j$ (in other words, if it is possible to complete the diagram above by the dotted arrow $u$ making it \emph{commutative}).

For that, consider an affine open set $U = \Spec(C)$ of $Y$;
its inverse image $j^{-1}(U)$ is the affine open $U_0 = \Spec(C/\mathfrak{L})$, where $\mathfrak{L} = \Gamma(U, \mathfrak{L})$, \emph{zero-square} ideal in $C$;
suppose that $U$ is small enough so that $u_0(U_0)$ is contained in an affine open $V = \Spec(B)$ of $X$ and that $g(U) = f(u_0(U_0))$ is contained in an affine open $W = \Spec(A)$ of $S$, so that $B$ and $C$ are $A$-algebras and $u_0|U_0$ corresponds to an $A$-homomorphism $\psi$ from $B$ to $C/\mathfrak{L}$;
Let $P(U_0)$ be the set of restrictions $u|U$ of the sought homomorphisms, which corresponds canonically to $A$-homomorphisms of algebras $\phi:B \to C$ such that the \emph{composite} $B \xrightarrow{\phi} C \to C/\mathfrak{L}$ is equal to $\psi$.
So we know \sref[0]{0.20.1.1} that the set of such homomorphisms is either empty or of the form $\psi_1 + \Der_A(B, \mathfrak{L})$;
since $P(U_0)$ is not empty, the additive group $\Der_A(B, \mathfrak{L})$ acts by addition on $P(U_0)$, which is therefore an \emph{affine space} for the additive group $\Der_A(B, \mathfrak{L})$ (or even a \emph{principal homogeneous space} (or \emph{torsor}) for $\Der_A(B, \mathfrak{L})$).

Now notice that, since $\mathfrak{L}$ is endowed with a $B$-module structure via $\psi$, we have an isomorphism $v \mapsto v \circ d_{B/A}$ of $\Hom_B(\Omega_{X/S}^1, \mathfrak{L})$ onto $\Der_A(B, \mathfrak{L})$ \sref[0]{0.20.4.8}.
Besides, as $\mathfrak{L}$ is square-zero, therefore a $(C/\mathfrak{L})$-module, every $B$-homomorphism $v: \Omega_{X/S}^1 \to \mathfrak{L}$ can be considered as a $(C/\mathfrak{L})$-homomorphism $\Omega_{X/S}^1 \otimes_B (C/\mathfrak{L}) \to \mathfrak{L}$.
As $\sh{I}$ is square-zero, it can be considered as a quasi-coherent $\sh{O}_{Y_0}$-module;
let's introduce the $\sh{O}_{Y_0}$-module
\[
  \label{IV.16.5.14.2}
  \sh{G} = \shHom(u_0^*(\Omega_{X/S}^1), \sh{I});
  \tag{16.5.14.2}
\]
it follows from the fact that $\Omega_{B/A}^1 = \Gamma(V, \Omega_{X/S}^1)$ \sref{IV.16.3.7} that we can write $\Der_A(B, \mathfrak{L}) = \Gamma(U_0, \sh{G})$.

As $P(U_0)$ is defined as a set of $S$-morphisms $U \to X$, it is clear that $U_0 \mapsto P(U_0)$ is a \emph{sheaf of sets} $\sh{P}$ on $Y_0$.
We can use this fact to prove that the mapping $h:\Gamma(U_0, \sh{G}) \times P(U_0) \to P(U_0)$ defining the torsor structure on $P(U_0)$ is independent of choice of $V$ and $W$ and also that, if $U' \subset U$ is a second affine open of $Y$, $U'_0$ the its inverse image in $Y_0$, the diagram
\[
  \label{IV.16.5.14.3}
  \xymatrix{
    \Gamma(U_0, \sh{G}) \times P(U_0) \ar[d] \ar[r]^-h & P(U_0) \ar[d] \\
    \Gamma(U'_0, \sh{G}) \times P(U'_0) \ar[r]_-{h'} & P(U'_0)
  }
  \tag{16.5.14.3}
\]
is commutative (the vertical arrows being the restrictions).
In light of the above remark, we are reduced to proving the commutativity of the above diagram when $h$ is defined as such from affine opens $V$, $W$ and $h'$ from affine
\oldpage[IV-4]{33}
opens $V' \subset V$ and $W' \subset W$.
But in light of the preceding description of $h$, this results from the commutativity of the diagram \sref[0]{0.20.5.4.2}.

The mapping $\Gamma(U_0, \sh{G}) \times P(U_0) \to P(U_0)$ therefore define a homomorphism of \emph{sheaf of sets} $m:\sh{G} \times \sh{P} \times \sh{P}$ such that, for all open sets $U_0$ for which $\Gamma(U_0, \sh{P}) \neq \emp$, $m_{U_0}:\Gamma(U_0, \sh{G}) \times \Gamma(U_0, \sh{P}) \to \Gamma(U_0, \sh{P})$ is an external law defining in $\Gamma(U_0, \sh{P})$ a torsor structure for the group $\Gamma(U_0, \sh{G})$.
\end{env}

\begin{env}[16.5.15]
\label{IV.16.5.15}
In general, when we are given a sheaf of sets $\sh{P}$ over a topological space $Z$, a sheaf of groups $\sh{G}$ (not necessarily commutative) and a homomorphism of sheaves of sets $m:\sh{G} \to \sh{P} \to \sh{P}$ such that, for every open $U \subset Z$ such that $\Gamma(U, \sh{P}) \neq \emp$, $m_U:\Gamma(U, \sh{G}) \times \Gamma(U, \sh{P}) \to \Gamma(U, \sh{P})$ makes $\Gamma(U, \sh{P})$ a \emph{torsor} for the group $\Gamma(U,\sh{G})$, we say that $\sh{P}$ is a \emph{pseudo-torsor} (or \emph{formally principal homogeneous sheaf}) for the sheaf of groups $\sh{G}$.
We say that $\sh{P}$ is a \emph{torsor} (or \emph{principal homogeneous sheaf}) for $\sh{G}$
\footnote{
  [trans.] This is nowadays more commonly called a $\sh{G}$-torsor rather then a torsor \emph{over} $\sh{G}$.
}
if also $\Gamma(U, \sh{P}) \neq \emp$ for all open sets $U \neq \emp$ in a suitable basis for the topology of $Z$.

For the general theory of torsors, we reference \cite{IV-42};
we will limit ourselves to recalling the canonical correspondence between isomorphism classes of torsors (for \emph{given} $\sh{G}$) and elements from the cohomology $\HH^1(Z, \sh{G})$.
Consider, indeed, a torsor $\sh{P}$ for $\sh{G}$ and a open cover $(U_\lambda)$ of $Z$ such that $\Gamma(U_\lambda, \sh{P}) \neq \emp$ for every $\lambda$;
denote by $p_\lambda$ an element of $\Gamma(U_\lambda, \sh{P})$.
For every pair of indexes $\lambda, \mu$ such that $U_\lambda \cap U_\mu \neq \emp$, there is one and only one element $\gamma_{\lambda\mu}$ of $\Gamma(U_\lambda \cap U_\mu, \sh{G})$ such that $\gamma_{\lambda\mu} . (p_\mu|U_\lambda \cap U_\mu) = p_\lambda|U_\lambda \cap U_\mu$;
also, if $\lambda, \mu, \nu$ are three indexes such that $U_\lambda \cap U_\mu \cap U_\nu \neq \emp$, the restrictions $\gamma'_{\lambda\mu}$, $\gamma'_{\mu\nu}$, $\gamma'_{\lambda\nu}$ of $\gamma_{\lambda\mu}$, $\gamma_{\mu\nu}$, $\gamma_{\lambda\nu}$ to $U_\lambda \cap U_\mu \cap U_\nu$ verify the condition $\gamma'_{\lambda\nu} = \gamma'_{\lambda\mu}\gamma'_{\mu\nu}$;
in other words, $(\lambda, \mu) \mapsto \gamma_{\lambda\mu}$ is a $1$-cocycle of the covering $(U_\lambda)$ with values in $\sh{G}$.
If, for every $\lambda$, $p'_\lambda$ is a second element of $\Gamma(U_\lambda, \sh{P})$, it exists one and only one element $\beta_\lambda \in \Gamma(U_\lambda, \sh{G})$ such that $p'_\lambda = \beta_\lambda . p_\lambda$, and the $1$-cocycle $(\gamma'_{\lambda\mu})$ corresponding to the family $(p'_\lambda)$ is given by $\gamma'_{\lambda\mu} = \beta_\lambda \gamma_{\lambda\mu} \beta_\mu^{-1}$, that is, it is \emph{cohomologous} to $\gamma_{\lambda\mu}$.
On the other hand, the data of a $1$-cocycle $(\gamma_{\lambda\mu})$ defines, for every pair $(\lambda, \mu)$, an automorphism $\theta_{\lambda\mu}$ of the sheaf \emph{of sets} $\sh{G}|U_\lambda \cap U_\mu$, namely the right translation by $\gamma_{\lambda\mu}$, and the fact that it is a cocycle shows that we can \emph{glue} the sheaves of sets $\sh{G}|U_\lambda$ via the automorphisms $\theta_{\lambda\mu}$ \sref[0]{0.3.3.1};
we obtain as such a torsor over $\sh{G}$, call it $\sh{P}$, and if we take for $p_\lambda$ the unit section over $U_\lambda$, the corresponding $1$-cocycle is exactly the given $1$-cocycle $(\gamma_{\lambda\mu})$;
also, if we replace $(\gamma_{\lambda\mu})$ by an $1$-cocycle $\gamma'_{\lambda\mu} = \beta_\lambda \gamma_{\lambda\mu} \beta_\mu^{-1}$ cohomologous to it we verify immediately that the torsor obtained is isomorphic to $\sh{P}$.

In particular,if $(\gamma_{\lambda\mu})$ is a $1$-coboundary, in other words of the form $\gamma_{\lambda\mu} = \beta_\lambda\beta_\mu^{-1}$, the obtained torsor $\sh{P}$ is \emph{isomorphic} to $\sh{G}$ (considered as a torsor over itself by left translations);
we say in this case that $\sh{P}$ is trivial, and the converse is obvious.

In particular, it results from \sref[III]{III.1.3.1} that:
\end{env}

\begin{proposition}[16.5.16]
\label{IV.16.5.16}
Let $Z$ be an affine scheme and $\sh{G}$ a quasi-coherent $\sh{O}_Z$-module;
then every torsor over $\sh{G}$ is trivial.
\end{proposition}

\oldpage[IV-4]{34}

Returnning to the problem considered in \sref{IV.16.5.13}, we obtain:

\begin{proposition}[16.5.17]
\label{IV.16.5.17}
Let $X$, $Y$ be two $S$-preschemes, $Y_0$ a closed subprescheme of $Y$ defined by a quasi-coherent ideal $\sh{I}$ of $\sh{O}_Y$ such that $\sh{I}^2 = 0$, $j:Y_0 \to Y$ is the canonical injection.
Let $u_0:Y_0 \to X$ be an $S$-morphism, and $\sh{P}$ the sheaf of sets on $Y$ such that, for every open set $U$ of $Y$, $\Gamma(U, \sh{P})$ is the set of $S$-morphisms $u:X \to X$ such that $u_0|U_0 = u \circ (j|U_0)$, where $U_0 = j^{-1}(U)$.
Then it exists on $\sh{P}$ a structure of pseudo-torsor over the $\sh{O}_{Y_0}$-module $\sh{G} = \shHom_{\sh{O}_{Y_0}}(u_0^*(\Omega_{X/S}^1), \sh{I})$.
\end{proposition}

In particular:

\begin{corollary}[16.5.18]
\label{IV.16.5.18}
Under the notations of \sref{IV.16.5.16}, suppose that $Y$ is affine and $\Omega_{X/S}^1$ is of finite presentation;
if there is a open cover $(U_\alpha)$ of $Y$, and, for every index $\alpha$, an $S$-morphism $v_\alpha:U_\alpha \to X$ such that, if $U_\alpha^0 = j^{-1}(U_\alpha)$, we have $v_\alpha \circ (j|U_\alpha^0) = u_0|U_\alpha^0$, then there is an $S$-morphism $u:Y \to X$ such that $u \circ j = u_0$.
\end{corollary}

\begin{proof}
Indeed, $\sh{G}$ is a quasi-coherent $\sh{O}_{Y_0}$-module \sref[I]{I.1.3.12};
by \sref{IV.16.5.16} and the fact that $Y_0$ is then affine, the sheaf $\sh{P}$, which is by hypothesis a torsor over $\sh{G}$, not only a pseudo-torsor, is \emph{trivial};
but if $w$ is an isomorphism from $\sh{G}$ to $\sh{P}$ (as it is a torsor over $\sh{G}$), the image by $w$ of the zero section of $\sh{G}$ is the $S$-morphism we're looking for.
\end{proof}